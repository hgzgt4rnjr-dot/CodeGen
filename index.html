<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CodeGen ‚Äì Create System</title>

  <!-- PWA bits (keep standalone app feel) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="CodeGen">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#00ff90">

  <style>
    :root{
      --bg:#000; --fg:#e8ffe8; --accent:#00ff90; --muted:#8a8a8a; --danger:#ff4d6d; --mk:#00c8ff; --tmk:#ff00ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,system-ui,Helvetica,Arial}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    h1{font-size:24px;margin:6px 0 12px;color:var(--accent)}
    .card{background:#0e0e0e;border:1px solid #151515;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 8px 30px rgba(0,0,0,0.35)}
    label{display:block;font-size:13px;color:#bdbdbd;margin:10px 0 6px}
    input[type=text]{width:100%;background:#0a0a0a;border:1px solid #1e1e1e;color:var(--fg);border-radius:12px;padding:12px 14px;font-size:16px;outline:none}
    input[type=text]::placeholder{color:#666}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 160px}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:1px solid #1f1f1f;background:#111;color:var(--fg);padding:10px 14px;border-radius:12px;font-size:15px}
    button.primary{background:var(--accent);color:#002a16;border-color:#00c070;font-weight:600}
    button.warn{background:#1b0006;color:#ffd9e0;border-color:#3a0a16}
    button:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .out{white-space:pre-wrap;background:#060606;border:1px solid #101010;border-radius:12px;padding:12px;max-height:50vh;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:14px;line-height:1.35}
    .ok{color:var(--fg)}
    .mk{color:var(--mk)}
    .err{color:var(--danger)}
    .tmk{color:var(--tmk)}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#121212;border:1px solid #202020;margin-left:8px;color:#ccc}
    .footer{margin-top:10px;font-size:12px;color:#8d8d8d}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .hint{font-size:12px;color:#aaa}
    #array {
      text-transform: uppercase;
    }

    #array::placeholder {
      text-transform: none;
    }


        /* Modal (Array Assist) */
    .modal[hidden]{display:none!important}
    .modal{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      z-index:9999;
    }
    .modal .backdrop{
      position:absolute; inset:0; background:rgba(0,0,0,0.55); backdrop-filter: blur(2px);
    }
    .modal .dialog{
      position:relative; background:#0e0e0e; border:1px solid #202020; border-radius:16px;
      width:min(92vw,560px); padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.6)
    }
    .modal h3{margin:0 0 8px 0; color:var(--accent); font-size:18px}
    .modal .row{display:flex; gap:10px; margin-top:8px}
    .modal .row > div{flex:1 1 160px}
    .modal .btnbar{display:flex; gap:10px; justify-content:flex-end; margin-top:14px}
    .modal input[type=number]{
      width:100%; background:#0a0a0a; border:1px solid #1e1e1e; color:var(--fg);
      border-radius:12px; padding:10px 12px; font-size:16px; outline:none
    }
        /* Segmented buttons for pin size */
    .seg button.selected{
      background: var(--accent);
      color: #002a16;
      border-color: #00c070;
      font-weight: 600;
    }


  </style>
</head>
<body>
  <!-- Main Screen -->
  <div id="mainScreen"
       style="display:flex;flex-direction:column;justify-content:center;align-items:center;
              height:100vh;text-align:center;background:#000;">
    <h1 style="font-size:38px;margin-bottom:40px;color:#00ff90;font-weight:700;">
      Welcome to CodeGen V5
    </h1>

    <div style="display:flex;flex-direction:column;gap:16px;width:200px;">
      <button id="goCreate"
              class="primary"
              style="padding:14px 20px;font-size:17px;border-radius:14px;font-weight:600;">
        Create System
      </button>
      <button id="goLoad"
              style="background:#111;border:1px solid #333;color:#e0e0e0;
                     padding:14px 20px;font-size:17px;border-radius:14px;">
        Load System
      </button>
      <button id="goManager"
              style="background:#111;border:1px solid #333;color:#e0e0e0;
                     padding:14px 20px;font-size:17px;border-radius:14px;">
        System Manager
      </button>
    </div>


    <footer style="position:absolute;bottom:20px;color:#666;font-size:13px;">
      ¬© 2025 CodeGen Systems
    </footer>
  </div>

  <!-- Load Screen -->
  <div id="loadScreen" class="wrap" style="display:none;min-height:100vh;flex-direction:column;">
    <h1>Load System</h1>

    <div id="loadList"
         class="card"
         style="flex:1 1 auto;overflow:auto;padding:0;display:flex;flex-direction:column;">
      <!-- rows rendered by JS -->
    </div>

    <div class="btnbar" style="justify-content:flex-end;position:sticky;bottom:0;background:#0e0e0e;padding:12px;border-radius:12px;margin-top:12px;">
      <button id="returnMainFromLoad">Return to Main</button>
      <button id="openSystem" class="primary" disabled>Open System</button>
    </div>
  </div>


  <!-- System Manager Screen -->
  <div id="managerScreen" class="wrap" style="display:none;min-height:100vh;flex-direction:column;">
    <h1>System Manager</h1>

    <div id="managerList"
         class="card"
         style="flex:1 1 auto;overflow:auto;padding:0;display:flex;flex-direction:column;">
      <!-- rows rendered by JS -->
    </div>

    <div class="btnbar" style="justify-content:flex-end;position:sticky;bottom:0;background:#0e0e0e;padding:12px;border-radius:12px;margin-top:12px;">
      <button id="btnImport">Import Systems</button>
      <button id="btnBackup">Create Backup</button>
      <button id="btnDelete" class="warn">Delete System</button>
      <button id="returnMainFromManager" class="primary">Return to Main</button>
    </div>
  </div>

  <!-- System Screen -->
  <div id="systemScreen" class="wrap" style="display:none;min-height:100vh;">
    <h1>
      <span id="sysViewId" style="font-weight:700;letter-spacing:.5px;"></span>
      <span style="color:#888;margin:0 6px;">‚Äì</span>
      <span id="sysViewDesc" class="muted" style="font-size:18px;"></span>
    </h1>



    <div class="card" style="margin-top:8px;">
      <div class="inline" style="justify-content:space-between; width:100%; flex-wrap:wrap; gap:10px;">
        <div class="btnbar" style="margin-top:0">
          <button id="btnSysKeys">Keys</button>
          <button id="btnSysDoors">Doors</button>
          <button id="btnSysTree">Coding Tree</button>
          <button id="btnSysNotes">System Notes</button>
          <button id="btnSysClose">Close System</button>
        </div>
      </div>
    </div>

    <div id="systemContent" class="card" style="min-height:120px;">
      <div class="muted">Choose an option above.</div>
    </div>
  </div>

  <!-- Create Screen -->
  <div id="createScreen" class="wrap" style="display:none">
    <h1>Create System <span class="tag">TMK ‚Üí MK ‚Üí CK</span></h1>


    <div class="card">
      <div class="row">

        <div>
          <label for="tmk">TMK (digits, e.g. 53142). Tap R5/R6 to auto-generate.</label>
          <input id="tmk" type="text" inputmode="numeric" placeholder="Enter TMK like 53142">
        </div>
        <div>
          <label for="array">Array (same length as TMK; use M/C/0 per position)</label>
          <input id="array" type="text" placeholder="Example: M00MC">
          <div class="hint">Each character: <b>M</b>=Master Key, <b>C</b>=Change Key, <b>0</b>=Empty. Length must equal TMK.</div>
        </div>
      </div>

      <div class="btnbar">
        <button id="r5">üé≤ R5</button>
        <button id="r6">üé≤ R6</button>
        <button class="primary" id="build">Build Coding Tree</button>
        <button id="assist">Coding Assist</button>
        <button id="clear">Clear</button>
        <button id="reduce">Reduce Errors</button>
      </div>
    </div>

    <div class="card">
      <div class="inline">
        <strong>Output</strong>
        <span class="tag" id="stats">‚Äî</span>
      </div>
      <div id="out" class="out" aria-live="polite">Enter TMK + Array, then press ‚ÄúBuild Coding Tree‚Äù.</div>
      <div class="btnbar">
        <button id="copy">Copy</button>
        <button id="saveSystem">Save System</button>
        <button id="returnMain">Return to Main</button>
        <span class="hint">MKs in cyan, CKs in white, errors in red.</span>
      </div>
      <div class="footer">Rules enforced: Maximum Adjacent Cut &gt; 7 (MAC), Deepest First Cut ‚â• 8 (DFC) and Minimum Code Variation ‚â• 3 (MCV). Depth Step of Two.</div>
    </div>
  </div>

    <!-- Array Assist Modal -->
  <div id="assistModal" class="modal" hidden>
    <div class="backdrop" id="assistBackdrop"></div>
    <div class="dialog">
      <h3>Coding Assist</h3>
      <p class="muted" style="margin:6px 0 10px 0;">
        Enter the system's size below. We‚Äôll build the system to meet your requirements.
      </p>

      <div class="btnbar seg" style="margin-top:6px; justify-content:flex-start;">
        <button id="assistPin5">5 Pin</button>
        <button id="assistPin6">6 Pin</button>
      </div>
      
      <div class="row">
        <div>
          <label for="assistMk">Master Keys</label>
          <input id="assistMk" type="number" inputmode="numeric" min="0" step="1" placeholder="e.g. 5">
        </div>
        <div>
          <label for="assistCk">Change Keys</label>
          <input id="assistCk" type="number" inputmode="numeric" min="0" step="1" placeholder="e.g. 30">
        </div>
      </div>

      <div class="btnbar">
        <button id="assistCancel">Cancel</button>
        <button class="primary" id="assistDone">Done</button>
      </div>
    </div>
  </div>

    <!-- Reduce Errors ‚Äì Confirm -->
  <div id="reduceConfirm" class="modal" hidden>
    <div class="backdrop" id="reduceConfirmBackdrop"></div>
    <div class="dialog">
      <h3>Reduce Errors</h3>
      <p class="muted" style="margin:6px 0 12px 0;">
        <strong>Please Note:</strong> This will change the current TMK. Press <b>Start</b> to continue. You can run this multiple times until satisfied.
      </p>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="reduceCancel">Cancel</button>
        <button class="primary" id="reduceStart">Start</button>
      </div>
    </div>
  </div>

  <!-- Reduce Errors ‚Äì Result -->
  <div id="reduceResult" class="modal" hidden>
    <div class="backdrop" id="reduceResultBackdrop"></div>
    <div class="dialog">
      <h3>Processing Complete</h3>
      <pre id="reduceSummary" style="background:#060606;border:1px solid #101010;border-radius:12px;padding:10px;white-space:pre-wrap;margin:8px 0 12px 0;"></pre>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="reduceResultCancel">Cancel</button>
        <button class="primary" id="reduceAccept">Accept</button>
      </div>
    </div>
  </div>

  <!-- Save System Modal -->
  <div id="saveModal" class="modal" hidden>
    <div class="backdrop" id="saveBackdrop"></div>
    <div class="dialog">
      <h3>Save System</h3>
      <div class="row">
        <div>
          <label for="sysNumber">System Number</label>
          <input id="sysNumber" type="text" placeholder="SYS0001">
        </div>
        <div>
          <label for="sysDescription">System Description</label>
          <input id="sysDescription" type="text" placeholder="e.g. North Wing ‚Äì 5-pin">
        </div>
      </div>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="saveCancel">Cancel</button>
        <button class="primary" id="saveOk">OK</button>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="confirmDeleteModal" class="modal" hidden>
    <div class="backdrop" id="confirmDeleteBackdrop"></div>
    <div class="dialog">
      <h3>Are you sure you want to delete system?</h3>
      <div id="confirmDeleteLine" class="muted" style="margin:8px 0 12px 0;"></div>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="confirmDeleteCancel">Cancel</button>
        <button id="confirmDeleteGo" class="warn">Confirm Delete</button>
      </div>
    </div>
  </div>






  <script>
    // ---------- Utility ----------
    const $ = s => document.querySelector(s);
    const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

    function hasMaxAdjacentCutError(arr){
      for (let i=0;i<arr.length-1;i++){
        if (Math.abs(arr[i]-arr[i+1])>7) return true;
      }
      return false;
    }
    function hasDeepestFirstCutError(arr){
      return arr[0] >= 8;
    }
    function generateRandomTMK(pinCount){
      // Retry until it passes both checks
      while(true){
        const tmk = Array.from({length: pinCount}, ()=>randInt(0,9));
        if (!hasMaxAdjacentCutError(tmk) && !hasDeepestFirstCutError(tmk)) {
          return tmk.join('');
        }
      }
    }
    function evenSet(exclude){ // 0,2,4,6,8 except 'exclude'
      const s=[0,2,4,6,8]; return s.filter(v=>v!==exclude);
    }
    function oddSet(exclude){ // 1,3,5,7,9 except 'exclude'
      const s=[1,3,5,7,9]; return s.filter(v=>v!==exclude);
    }
    // Min Variation Rule (MVR): require at least one pair of digits >= 3 apart.
    // If (max - min) < 3, it violates the rule => error (true).
    function hasMinVariationError(arr){
      if (!arr || !arr.length) return true;
      let min = 9, max = 0;
      for (let i=0;i<arr.length;i++){
        const v = arr[i];
        if (v < min) min = v;
        if (v > max) max = v;
      }
      return (max - min) < 3;
    }


    // ---------- Core generation (ported from your Python) ----------
    function buildCodingTree(tmkStr, arrayStr){
      const tmk = tmkStr.split('').map(d=>+d);
      const masterPos = [...arrayStr].map((c,i)=>c.toUpperCase()==='M'?i:-1).filter(i=>i>=0);
      const changePos = [...arrayStr].map((c,i)=>c.toUpperCase()==='C'?i:-1).filter(i=>i>=0);

      // Generate all Master Keys by varying the M positions with same-parity progressions (exclude original)
      const masterKeys = [];
      (function genMK(cuts, idx){
        if (idx >= masterPos.length){ masterKeys.push(cuts.slice()); return; }
        const pos = masterPos[idx];
        const orig = tmk[pos];
        const options = (orig % 2 === 0) ? evenSet(orig) : oddSet(orig);
        for (const depth of options){
          cuts[pos] = depth;
          genMK(cuts, idx+1);
        }
        cuts[pos] = orig;
      })(tmk.slice(), 0);

      // For each MK, generate all CKs by varying the C positions with same-parity progressions (exclude original)
      function genCKs(base){
        const res=[];
        (function rec(cuts, idx){
          if (idx >= changePos.length){ res.push(cuts.slice()); return; }
          const pos = changePos[idx];
          const orig = cuts[pos];
          const options = (orig % 2 === 0) ? evenSet(orig) : oddSet(orig);
          for (const depth of options){
            cuts[pos] = depth;
            rec(cuts, idx+1);
          }
          cuts[pos] = orig;
        })(base.slice(), 0);
        return res;
      }

      // Assemble printable lines and CSV rows
      const lines=[];
      const csvRows=[["Key","Code","Error"]];

      lines.push(`TMK   : ${tmkStr}`);
      lines.push(`Array : ${arrayStr}`);
      lines.push("");

      // Add TMK/Array at the top of CSV (after header)
      csvRows.push(["TMK", tmkStr, ""]);
      csvRows.push(["Array", String(arrayStr).toUpperCase(), ""]);

      // GMK appears only if Array contains an M; GMK equals TMK code
      if (/[Mm]/.test(arrayStr)) {
        lines.push(`GMK - ${tmkStr}`);
        lines.push("");
        csvRows.push(["GMK", tmkStr, ""]);
      }



      let mkCount=0, ckTotal=0, errorCount=0;
       if (masterPos.length === 0 && changePos.length === 0) {
        const ckAdj  = hasMaxAdjacentCutError(tmk);
        const ckDeep = hasDeepestFirstCutError(tmk);
        const ckMvr  = hasMinVariationError(tmk);
        const ckErrMsg = [ ckAdj && "MAC Error", ckDeep && "DFC Error", ckMvr && "MCV Error" ]
                           .filter(Boolean).join(" & ");
        if (ckErrMsg) errorCount++;
        ckTotal = 1;


        // Match your CK line format (four leading spaces, pad label to 8)
        const ckLabel = 'CK1.1';
        lines.push(`    ${ckLabel.padEnd(8)} - ${tmkStr}${ckErrMsg?("  " + ckErrMsg):""}`);
        csvRows.push([ckLabel, tmkStr, ckErrMsg]);
        lines.push("");

        return { lines, csvRows, mkCount, ckTotal, errorCount };
      }

      masterKeys.forEach((mkCuts, i)=>{
        mkCount++;
        const mkLabel = `MK${i+1}`;
        const mkErrAdj  = hasMaxAdjacentCutError(mkCuts);
        const mkErrDeep = hasDeepestFirstCutError(mkCuts);
        const mkErrMvr  = hasMinVariationError(mkCuts);
        const mkErrMsg = [ mkErrAdj && "MAC Error", mkErrDeep && "DFC Error", mkErrMvr && "MCV Error" ]
                           .filter(Boolean).join(" & ");

        if (mkErrMsg) errorCount++;

        const mkCode = mkCuts.join("");


        lines.push(`%c${mkLabel} - ${mkCode}${mkErrMsg?("  " + mkErrMsg):""} %c`.trim());
        csvRows.push([mkLabel, mkCode, mkErrMsg]);

        const cks = genCKs(mkCuts);
        cks.forEach((ckCuts, j)=>{
          ckTotal++;
          const ckLabel = `CK${i+1}.${(j+1)}`;
          const ckCode = ckCuts.join("");
          // CK error carries MK adjacent error OR own adjacent; + own deepest-first + MVR
          const ckAdj  = mkErrAdj || hasMaxAdjacentCutError(ckCuts);
          const ckDeep = hasDeepestFirstCutError(ckCuts);
          const ckMvr  = hasMinVariationError(ckCuts);
          const ckErrMsg = [ ckAdj && "MAC Error", ckDeep && "DFC Error", ckMvr && "MCV Error" ]
                             .filter(Boolean).join(" & ");

          if (ckErrMsg) errorCount++;


          lines.push(`    ${ckLabel.padEnd(8)} - ${ckCode}${ckErrMsg?("  " + ckErrMsg):""}`);
          csvRows.push([ckLabel, ckCode, ckErrMsg]);
        });

        lines.push(""); // spacer between MK groups
      });

      return { lines, csvRows, mkCount, ckTotal, errorCount };
    }

    // --- Reduce Errors helpers (global) ---
    function variationScoreFromTMK(tmkStr){
      // Higher variation between adjacent cuts preferred
      const d = tmkStr.split('').map(n=>+n);
      let s = 0;
      for (let i=0;i<d.length-1;i++) s += Math.abs(d[i]-d[i+1]);
      return s;
    }

    function evaluateTMK(tmkStr, arrayStr){
      const { errorCount } = buildCodingTree(tmkStr, arrayStr);
      return {
        tmk: tmkStr,
        errors: errorCount,
        varScore: variationScoreFromTMK(tmkStr)
      };
    }


    // ---------- UI wiring ----------
    let outEl = $('#out');
    const statsEl = $('#stats');


      function printLines(lines){
        const html = lines.map(line=>{
            const hasErr = /(?:MAC|DFC|MCV)\s*Error/.test(line); // catches Errors


            if (line.startsWith('%cMK')) {
                // MK line with style markers
                const safe = line
                    .replace(/%c/g,'')
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;');

                if (hasErr) {
                    // Whole MK line red (label + code + error)
                    return `<span class="err">${safe}</span>`;
                } else {
                    // MK label cyan, rest normal
                    const [head, ...rest] = safe.split('  ');
                    const tail = rest.join('  ');
                    return `<span class="mk">${head}</span>${tail ? `  ${tail}` : ''}`;
                }


            } else if (line.startsWith('GMK -')) {
                const esc = line
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;');
                return `<span class="tmk">${esc}</span>`;

            } else if (line.startsWith('TMK   :')) {
                const esc = line
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;');
                return esc;


            } else {
                // CK lines and any other lines
                const esc = line
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;');
                return hasErr ? `<span class="err">${esc}</span>` : esc;
            }
        }).join('\n');

        outEl.innerHTML = html;
    }


    function toCSV(rows){
      return rows.map(r=>r.map(v=>{
        const s = (v==null?'':String(v));
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');
    }

    $('#r5').onclick = ()=>{
      const r = generateRandomTMK(5);
      $('#tmk').value = r;
    };
    $('#r6').onclick = ()=>{
      const r = generateRandomTMK(6);
      $('#tmk').value = r;
    };

        // Force uppercase as user types in the Array input
    document.getElementById('array').addEventListener('input', e => {
      const cursor = e.target.selectionStart;
      e.target.value = e.target.value.toUpperCase();
      e.target.setSelectionRange(cursor, cursor);
    });


        // ---------- Array Assist (modal) ----------
    function openAssist(){
      const modal = document.getElementById('assistModal');
      document.getElementById('assistMk').value = '';
      document.getElementById('assistCk').value = '';
      // reset pin selection
      window._assistPins = null;
      document.getElementById('assistPin5').classList.remove('selected');
      document.getElementById('assistPin6').classList.remove('selected');
      modal.hidden = false;
    }

    function closeAssist(){
      document.getElementById('assistModal').hidden = true;
    }
    // ceil(log4(x)), treating x <= 1 as 0
    function neededDesignations(x){
      const n = Number(x);
      if (!isFinite(n) || n <= 1) return 0;
      return Math.ceil(Math.log(n) / Math.log(4));
    }
    function buildArrayFromRequest(tmkStr, mkReq, ckReq){
      const N = tmkStr.length;
      const m = neededDesignations(mkReq);
            // Change Keys tweak: if user requests exactly 1 CK, force one 'C'
      let c = neededDesignations(ckReq);
      const ckNum = Number(ckReq);
      if (Number.isFinite(ckNum) && ckNum === 1) c = 1;
      
      if (m + c > N) {
        throw new Error(`Not enough chambers: need ${m+c}, have ${N}. Reduce requested counts.`);
      }
      // M...M C...C 0...0
      return '0'.repeat(N - m - c) + 'M'.repeat(m) + 'C'.repeat(c);
    }

    // Open modal
    document.getElementById('assist').onclick = openAssist;
    // Close actions
    document.getElementById('assistBackdrop').onclick = closeAssist;
    document.getElementById('assistCancel').onclick = closeAssist;

        // Pin size selection buttons
    document.getElementById('assistPin5').onclick = ()=>{
      window._assistPins = 5;
      document.getElementById('assistPin5').classList.add('selected');
      document.getElementById('assistPin6').classList.remove('selected');
    };
    document.getElementById('assistPin6').onclick = ()=>{
      window._assistPins = 6;
      document.getElementById('assistPin6').classList.add('selected');
      document.getElementById('assistPin5').classList.remove('selected');
    };

        // Done ‚Üí choose pin size, generate TMK, compute Array, auto-build
    document.getElementById('assistDone').onclick = ()=>{
      if (!window._assistPins){
        alert('Please select 5 Pin or 6 Pin.'); return;
      }
      const mkReq = document.getElementById('assistMk').value.trim();
      const ckReq = document.getElementById('assistCk').value.trim();
      if (mkReq==='' || ckReq===''){
        alert('Please enter both Master Keys and Change Keys.'); return;
      }
      try{
        // 1) Generate TMK for the chosen pin size
        const tmk = generateRandomTMK(window._assistPins);
        document.getElementById('tmk').value = tmk;

        // 2) Build Array and set it
        const arr = buildArrayFromRequest(tmk, mkReq, ckReq);
        document.getElementById('array').value = arr;

        // 3) Close modal and trigger Build
        closeAssist();
        document.getElementById('build').click();
      }catch(err){
        alert(err.message);
      }
    };

        // --- Reduce Errors flow ---
    const reduceConfirm = document.getElementById('reduceConfirm');
    const reduceResult = document.getElementById('reduceResult');
    const reduceSummary = document.getElementById('reduceSummary');

    function openReduceConfirm(){ reduceConfirm.hidden = false; }
    function closeReduceConfirm(){ reduceConfirm.hidden = true; }
    function openReduceResult(){ reduceResult.hidden = false; }
    function closeReduceResult(){ reduceResult.hidden = true; }

    // Open the confirm dialog
    document.getElementById('reduce').onclick = openReduceConfirm;
    document.getElementById('reduceConfirmBackdrop').onclick = closeReduceConfirm;
    document.getElementById('reduceCancel').onclick = closeReduceConfirm;

    // Close the result dialog by backdrop
    document.getElementById('reduceResultBackdrop').onclick = closeReduceResult;

    // Cancel on result => rebuild from original TMK
    document.getElementById('reduceResultCancel').onclick = ()=>{
      if (window._reduceOrigTMK && window._reduceOrigArr) {
        document.getElementById('tmk').value = window._reduceOrigTMK;
        document.getElementById('array').value = window._reduceOrigArr;
        document.getElementById('build').click();
      }
      closeReduceResult();
    };

    // Accept => set best TMK and build
    document.getElementById('reduceAccept').onclick = ()=>{
      if (window._reduceBest && window._reduceBest.tmk) {
        document.getElementById('tmk').value = window._reduceBest.tmk;
        document.getElementById('build').click();
      }
      closeReduceResult();
    };

    // Start the 10-trial search
    document.getElementById('reduceStart').onclick = ()=>{
      // Close confirm
      closeReduceConfirm();

      // Gather + validate current inputs
      const tmk = document.getElementById('tmk').value.trim();
      const arrRaw = document.getElementById('array').value.trim().replace(/\s+/g,'');
      const arrNorm = arrRaw.replace(/[oO]/g,'0').toUpperCase();

      if (!/^\d+$/.test(tmk) || tmk.length===0){ alert('Check TMK is Numbers Only.'); return; }
      if (arrNorm.length !== tmk.length){ alert('Array length must match TMK length.'); return; }
      if (!/^[MC0]+$/.test(arrNorm)){ alert('Array must contain only M, C, or 0.'); return; }
      if (arrNorm.includes('M') && !arrNorm.includes('C')) {
        alert('Array Incorrect. Master Keys can only be created if they have Change Keys underneath. Please add C into the Array to continue.');
        return;
      }

      // Remember the current state (for Cancel or if already optimal)
      window._reduceOrigTMK = tmk;
      window._reduceOrigArr = arrNorm;

      // Evaluate current TMK ("before")
      const before = evaluateTMK(tmk, arrNorm);

      // Choose pin length for trials using current TMK length (5 or 6)
      const N = tmk.length;

      // Run trial in reduce errors
      const trials = 1000;
      const candidates = [before];
      for (let i=0;i<trials;i++){
        const candTMK = generateRandomTMK(N);
        const cand = evaluateTMK(candTMK, arrNorm);
        candidates.push(cand);
      }

      // Pick the best: lowest errors; tie-breaker: RANDOM among equals
      const minErr = Math.min(...candidates.map(c => c.errors));
      const pool = candidates.filter(c => c.errors === minErr);
      const best = pool[Math.floor(Math.random() * pool.length)];

      window._reduceBest = best; // stash for Accept


      // Build summary text
      const pad = (s,w)=>String(s).padEnd(w,' ');
      const beforeLine1 = `TMK: ${before.tmk}`;
      const afterLine1  = `TMK: ${best.tmk}`;
      const beforeLine2 = `Errors: ${before.errors}`;
      const afterLine2  = `Errors: ${best.errors}`;

      reduceSummary.textContent =
`Before                After:
${pad(beforeLine1,22)}${afterLine1}
${pad(beforeLine2,22)}${afterLine2}`;

      // Show result modal with Cancel/Accept
      openReduceResult();
    };


    $('#clear').onclick = ()=>{
      $('#tmk').value = '';
      $('#array').value = '';
      outEl.textContent = 'Enter TMK + Array, then press ‚ÄúBuild Coding Tree‚Äù.';
      statsEl.textContent = '‚Äî';
    };

        $('#build').onclick = ()=>{
      // üîß Hard clear output window before rebuilding
      const freshOut = outEl.cloneNode(false); // clone without children
      outEl.parentNode.replaceChild(freshOut, outEl);
      outEl = freshOut;                        // update reference for printLines

      statsEl.textContent = '‚Äî';
      window._lastCSV = undefined;
      window._lastText = undefined;

      const tmk = $('#tmk').value.trim();
      const arrRaw = $('#array').value.trim().replace(/\s+/g,'');
      const arrNorm = arrRaw.replace(/[oO]/g,'0').toUpperCase();

      if (!/^\d+$/.test(tmk) || tmk.length===0){ alert('Check TMK is Numbers Only.'); return; }
      if (arrNorm.length !== tmk.length){ alert('Array length must match TMK length.'); return; }
      if (!/^[MC0]+$/.test(arrNorm)){ alert('Array must contain only M, C, or 0.'); return; }
                // Rule: M cannot exist without at least one C
      if (arrNorm.includes('M') && !arrNorm.includes('C')) {
        alert('Array Incorrect. Master Keys can only be created if they have Change Keys underneath. Please add C into the Array to continue.');
        return;
      }


      const {lines, csvRows, mkCount, ckTotal, errorCount} = buildCodingTree(tmk, arrNorm);
      printLines(lines);
      statsEl.textContent = `TMK ${tmk.length} Pin ¬∑ MKs ${mkCount} ¬∑ CK ${ckTotal} ¬∑ Errors ${errorCount}`;

      // stash for copy/save
      window._lastCSV = toCSV(csvRows);
      window._lastText = lines.join('\n');
      window._lastRows = csvRows;
      window._lastTMK = tmk;
      window._lastArray = arrNorm;
      window._lastStats = { mkCount, ckTotal, errorCount, pins: tmk.length };
    };




    $('#copy').onclick = async ()=>{
      if (!window._lastText){ alert('Build first.'); return; }
      try{
        await navigator.clipboard.writeText(window._lastText);
        alert('Copied results to clipboard.');
      }catch{
        // fallback
        const ta = document.createElement('textarea');
        ta.value = window._lastText;
        document.body.appendChild(ta);
        ta.select(); document.execCommand('copy');
        document.body.removeChild(ta);
        alert('Copied results to clipboard.');
      }
    };

    // Save System flow
    $('#saveSystem').onclick = ()=>{
      if (!window._lastText || !window._lastRows){ alert('Build first.'); return; }
      const { nextId } = getNextSystemId();
      document.getElementById('sysNumber').value = nextId;   // auto-fill (editable)
      document.getElementById('sysDescription').value = '';  // user can type anything
      openSaveModal();
    };



    // Keep offline functionality
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    }

    // ---- Save System (modal + storage) ----
    function openSaveModal(){ document.getElementById('saveModal').hidden = false; }
    function closeSaveModal(){ document.getElementById('saveModal').hidden = true; }

    // iOS Safari bookmark/PWA: localStorage persists in standalone mode.
    function getSystems(){
      try {
        const raw = localStorage.getItem('codegen_systems');
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }
    function setSystems(list){
      localStorage.setItem('codegen_systems', JSON.stringify(list || []));
    }
    function getNextSystemId(){
      const systems = getSystems();
      let max = 0;
      for (const s of systems){
        const m = /^SYS(\d{4})$/.exec(s && s.id ? s.id : '');
        if (m) max = Math.max(max, parseInt(m[1],10));
      }
      const nextNum = max + 1;
      const nextId = 'SYS' + String(nextNum).padStart(4,'0');
      return { nextId, nextNum };
    }

    // Modal wiring
    document.getElementById('saveBackdrop').onclick = closeSaveModal;
    document.getElementById('saveCancel').onclick = closeSaveModal;
    document.getElementById('saveOk').onclick = ()=>{
      const id = (document.getElementById('sysNumber').value || '').trim() || getNextSystemId().nextId;
      const description = (document.getElementById('sysDescription').value || '').trim();

      // Build object to persist (rich JSON)
      const system = {
        id,
        description,
        tmk: window._lastTMK,
        array: window._lastArray,
        stats: window._lastStats,
        lines: window._lastText ? window._lastText.split('\n') : [],
        rows: window._lastRows || []
      };

      // Upsert into localStorage
      const systems = getSystems();
      const idx = systems.findIndex(s => s.id === id);
      if (idx >= 0) systems[idx] = system; else systems.push(system);
      setSystems(systems);

      // Confirm then return to Main Menu
      closeSaveModal();
      alert('System Saved.');
      // clear the Create screen
      document.getElementById('clear').click();
      const mainScreen = document.getElementById('mainScreen');
      const createScreen = document.getElementById('createScreen');
      createScreen.style.display = 'none';
      mainScreen.style.display = 'flex';
      window.scrollTo(0,0);
    };


    // ---- Screen Navigation ----
    const mainScreen    = document.getElementById('mainScreen');
    const createScreen  = document.getElementById('createScreen');
    const loadScreen    = document.getElementById('loadScreen');
    const systemScreen  = document.getElementById('systemScreen');
    const managerScreen = document.getElementById('managerScreen');

    const loadListEl    = document.getElementById('loadList');
    const openBtn       = document.getElementById('openSystem');
    const managerListEl = document.getElementById('managerList');

    // system header els
    const sysViewId   = document.getElementById('sysViewId');
    const sysViewDesc = document.getElementById('sysViewDesc');

    let _selectedId = null;           // Load screen selection
    let _managerSelectedId = null;    // Manager screen selection
    let _currentSystem = null;



    function showMain(){
      mainScreen.style.display    = 'flex';
      createScreen.style.display  = 'none';
      loadScreen.style.display    = 'none';
      systemScreen.style.display  = 'none';
      managerScreen.style.display = 'none';
      window.scrollTo(0,0);
    }
    function showCreate(){
      mainScreen.style.display    = 'none';
      createScreen.style.display  = 'block';
      loadScreen.style.display    = 'none';
      systemScreen.style.display  = 'none';
      managerScreen.style.display = 'none';
      window.scrollTo(0,0);
    }
    function showLoad(){
      mainScreen.style.display    = 'none';
      createScreen.style.display  = 'none';
      systemScreen.style.display  = 'none';
      managerScreen.style.display = 'none';
      loadScreen.style.display    = 'flex';
      renderLoadList();
      window.scrollTo(0,0);
    }

    function showManager(){
      mainScreen.style.display    = 'none';
      createScreen.style.display  = 'none';
      loadScreen.style.display    = 'none';
      systemScreen.style.display  = 'none';
      managerScreen.style.display = 'flex';
      renderManagerList();
      window.scrollTo(0,0);
    }

    function showSystem(){
      mainScreen.style.display    = 'none';
      createScreen.style.display  = 'none';
      loadScreen.style.display    = 'none';
      managerScreen.style.display = 'none';
      systemScreen.style.display  = 'block';
      window.scrollTo(0,0);
    }



    // Main buttons
    document.getElementById('goCreate').onclick  = showCreate;
    document.getElementById('goLoad').onclick    = showLoad;
    document.getElementById('goManager').onclick = showManager;
    document.getElementById('returnMain').onclick = () => {
      document.getElementById('clear').click(); // clear the Create screen
      showMain();
    };

    // Load screen buttons
    document.getElementById('returnMainFromLoad').onclick = showMain;

    // Manager screen buttons
    document.getElementById('returnMainFromManager').onclick = showMain;
    document.getElementById('btnImport').onclick = ()=>{/* placeholder */};
    document.getElementById('btnBackup').onclick = ()=>{/* placeholder */};


    // System screen buttons
    (function(){
      const btnClose = document.getElementById('btnSysClose');
      const btnKeys  = document.getElementById('btnSysKeys');
      const btnDoors = document.getElementById('btnSysDoors');
      const btnTree  = document.getElementById('btnSysTree');
      const btnNotes = document.getElementById('btnSysNotes');
      const content  = document.getElementById('systemContent');

      if (btnClose) btnClose.onclick = () => {
        _currentSystem = null;
        showLoad();
      };

      // Simple placeholders for now
      if (btnKeys)  btnKeys.onclick  = ()=>{ if (content) content.innerHTML = '<div>Keys view (coming soon)</div>'; };
      if (btnDoors) btnDoors.onclick = ()=>{ if (content) content.innerHTML = '<div>Doors view (coming soon)</div>'; };
      if (btnTree)  btnTree.onclick  = ()=>{
        if (!_currentSystem || !content) return;
        const pre = document.createElement('pre');
        pre.className = 'out';
        pre.textContent = (_currentSystem.lines || []).join('\n');
        content.innerHTML = '';
        content.appendChild(pre);
      };
      if (btnNotes) btnNotes.onclick = ()=>{ if (content) content.innerHTML = '<div>System Notes (coming soon)</div>'; };
    })();


    // Build the load list from local storage
    function renderLoadList(){
      _selectedId = null;
      openBtn.disabled = true;

      const systems = getSystems();  // uses the helpers from the Save step
      if (!systems.length){
        loadListEl.innerHTML =
          '<div style="padding:16px;color:#aaa">No saved systems found.</div>';
        return;
      }

      loadListEl.innerHTML = '';
      systems.forEach((s, idx)=>{
        const row = document.createElement('button');
        row.type = 'button';
        row.style.cssText =
          'display:flex;justify-content:space-between;align-items:center;width:100%;' +
          'background:#0e0e0e;border:0;border-bottom:1px solid #1e1e1e;color:inherit;' +
          'padding:14px 16px;text-align:left;cursor:pointer';

        const left = document.createElement('div');
        left.innerHTML =
          `<div style="font-weight:600;letter-spacing:0.5px">${(s.id||'')}</div>` +
          `<div style="color:#9aa; font-size:13px; margin-top:2px">${((s.description||'')+'').replace(/</g,'&lt;')}</div>`;

        const right = document.createElement('div');
        right.style.cssText = 'font-size:12px;color:#8a8a8a';
        right.textContent = (s.stats && s.stats.pins) ? `${s.stats.pins}-pin` : '';

        row.appendChild(left);
        row.appendChild(right);

        row.onclick = ()=>{
          // clear previous selection visuals
          [...loadListEl.children].forEach(el=>{
            el.style.borderLeft = '0';
            el.style.background = '#0e0e0e';
          });
          // highlight this one
          row.style.borderLeft = '3px solid var(--accent)';
          row.style.background = '#0b0b0b';
          _selectedId = s.id;
          openBtn.disabled = false;
        };

        // rounding on first/last
        if (idx === 0) row.style.borderTopLeftRadius = row.style.borderTopRightRadius = '12px';
        if (idx === systems.length-1){
          row.style.borderBottom = '0';
          row.style.borderBottomLeftRadius = row.style.borderBottomRightRadius = '12px';
        }

        loadListEl.appendChild(row);
      });
    }
    // System Manager: render list
    // System Manager: render list
    function renderManagerList(){
      _managerSelectedId = null;

      const systems = getSystems();
      if (!systems.length){
        managerListEl.innerHTML =
          '<div style="padding:16px;color:#aaa">No saved systems found.</div>';
        return;
      }

      managerListEl.innerHTML = '';
      systems.forEach((s, idx)=>{
        const row = document.createElement('button');
        row.type = 'button';
        row.style.cssText =
          'display:flex;justify-content:space-between;align-items:center;width:100%;' +
          'background:#0e0e0e;border:0;border-bottom:1px solid #1e1e1e;color:inherit;' +
          'padding:14px 16px;text-align:left;cursor:pointer';

        const left = document.createElement('div');
        left.innerHTML =
          `<div style="font-weight:600;letter-spacing:0.5px">${(s.id||'')}</div>` +
          `<div style="color:#9aa; font-size:13px; margin-top:2px">${((s.description||'')+'').replace(/</g,'&lt;')}</div>`;

        const right = document.createElement('div');
        right.style.cssText = 'font-size:12px;color:#8a8a8a';
        right.textContent = (s.stats && s.stats.pins) ? `${s.stats.pins}-pin` : '';

        row.appendChild(left);
        row.appendChild(right);

        row.onclick = ()=>{
          [...managerListEl.children].forEach(el=>{
            el.style.borderLeft = '0';
            el.style.background = '#0e0e0e';
          });
          row.style.borderLeft = '3px solid var(--accent)';
          row.style.background = '#0b0b0b';
          _managerSelectedId = s.id;
        };

        if (idx === 0) row.style.borderTopLeftRadius = row.style.borderTopRightRadius = '12px';
        if (idx === systems.length-1){
          row.style.borderBottom = '0';
          row.style.borderBottomLeftRadius = row.style.borderBottomRightRadius = '12px';
        }

        managerListEl.appendChild(row);
      });

      // ---- Delete button + confirm modal wiring ----
      const confirmDeleteModal    = document.getElementById('confirmDeleteModal');
      const confirmDeleteBackdrop = document.getElementById('confirmDeleteBackdrop');
      const confirmDeleteLine     = document.getElementById('confirmDeleteLine');
      const confirmDeleteGo       = document.getElementById('confirmDeleteGo');
      const confirmDeleteCancel   = document.getElementById('confirmDeleteCancel');
      const btnDelete             = document.getElementById('btnDelete');

      function openConfirmDelete(id, desc){
        confirmDeleteLine.textContent = `${id} - ${desc || ''}`;
        confirmDeleteModal.hidden = false;
      }
      function closeConfirmDelete(){
        confirmDeleteModal.hidden = true;
      }

      confirmDeleteBackdrop.onclick = closeConfirmDelete;
      confirmDeleteCancel.onclick   = ()=>{ closeConfirmDelete(); };

      confirmDeleteGo.onclick = ()=>{
        const systemsNow = getSystems();
        const idx = systemsNow.findIndex(s => s.id === _managerSelectedId);
        if (idx >= 0){
          systemsNow.splice(idx,1);
          setSystems(systemsNow);
        }
        closeConfirmDelete();
        renderManagerList(); // refresh here, stay on manager
      };

      btnDelete.onclick = ()=>{
        if (!_managerSelectedId){
          alert('Select a system to delete.');
          return;
        }
        const sys = getSystems().find(x=>x.id===_managerSelectedId);
        if (!sys){ return; }
        openConfirmDelete(sys.id, sys.description || '');
      };
    }


    
    
    


    // Open selected system into its own System screen
    openBtn.onclick = ()=>{
      if (!_selectedId) return;
      const systems = getSystems();
      const sys = systems.find(x => x.id === _selectedId);
      if (!sys) return;

      _currentSystem = sys; // stash current
      if (sysViewId)   sysViewId.textContent = sys.id || '';
      if (sysViewDesc) sysViewDesc.textContent = sys.description || '';

      // default content view
      const content = document.getElementById('systemContent');
      if (content) content.innerHTML = '<div class="muted">Choose an option above.</div>';

      showSystem();
    };



  </script>
</body>
</html>
