<!-- 
  ¬© 2025 Daniel Allotta ‚Äî All rights reserved.
  This software is proprietary. Unauthorized copying, distribution, or modification is prohibited.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>CodeGen ‚Äì Create System</title>

  <!-- PWA bits (keep standalone app feel) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="CodeGen">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#00ff90">

  <style>
    :root{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    :root{
      --bg:#000; --fg:#e8ffe8; --accent:#00ff90; --muted:#8a8a8a; --danger:#ff4d6d; --mk:#00c8ff; --tmk:#ff00ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding-bottom:env(safe-area-inset-bottom);background:#000 url("background.png") center center/cover no-repeat fixed;color:var(--fg);font-family:-apple-system,system-ui,Helvetica,Arial}


    .wrap{max-width:900px;margin:0 auto;padding:20px}
    h1{font-size:24px;margin:6px 0 12px;color:var(--accent)}
    .card{background:#0e0e0e;border:1px solid #151515;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 8px 30px rgba(0,0,0,0.35)}
    label{display:block;font-size:13px;color:#bdbdbd;margin:10px 0 6px}
    input[type=text]{width:100%;background:#0a0a0a;border:1px solid #1e1e1e;color:var(--fg);border-radius:12px;padding:12px 14px;font-size:16px;outline:none}
    input[type=text]::placeholder{color:#666}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 160px}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:1px solid #1f1f1f;background:#111;color:var(--fg);padding:10px 14px;border-radius:12px;font-size:15px}
    button.primary{background:var(--accent);color:#002a16;border-color:#00c070;font-weight:600}
    button.warn{background:#1b0006;color:#ffd9e0;border-color:#3a0a16}
    button:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .out{white-space:pre-wrap;background:#060606;border:1px solid #101010;border-radius:12px;padding:12px;max-height:50vh;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:14px;line-height:1.35}
    .ok{color:var(--fg)}
    .mk{color:var(--mk)}
    .err{color:var(--danger)}
    .tmk{color:var(--tmk)}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#121212;border:1px solid #202020;margin-left:8px;color:#ccc}
    .footer{margin-top:10px;font-size:12px;color:#8d8d8d}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .hint{font-size:12px;color:#aaa}
    #array {
      text-transform: uppercase;
    }

    #array::placeholder {
      text-transform: none;
    }


        /* Modal (Array Assist) */
    .modal[hidden]{display:none!important}
    .modal{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      z-index:9999;
    }
    .modal .backdrop{
      position:absolute; inset:0; background:rgba(0,0,0,0.55); backdrop-filter: blur(2px);
    }
    .modal .dialog{
      position:relative; background:#0e0e0e; border:1px solid #202020; border-radius:16px;
      width:min(92vw,560px); padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.6)
    }
    .modal h3{margin:0 0 8px 0; color:var(--accent); font-size:18px}
    .modal .row{display:flex; gap:10px; margin-top:8px}
    .modal .row > div{flex:1 1 160px}
    .modal .btnbar{display:flex; gap:10px; justify-content:flex-end; margin-top:14px}
    .modal input[type=number]{
      width:100%; background:#0a0a0a; border:1px solid #1e1e1e; color:var(--fg);
      border-radius:12px; padding:10px 12px; font-size:16px; outline:none
    }
        /* Segmented buttons for pin size */
    .seg button.selected{
      background: var(--accent);
      color: #002a16;
      border-color: #00c070;
      font-weight: 600;
    }

    /* Keys grid */
    .keygrid {
      display:grid;
      grid-template-columns: 1.2fr 1.8fr 1.2fr .6fr;
      gap:8px;
      align-items:center;
      position:sticky;
      top:0;
      z-index:2;
      background:#0e0e0e;
    }
    .keygrid .hdr { font-weight:600; }


    /* Adjust header alignments in Keys grid */
    /* Description ‚Üí slightly right */
    .keygrid .hdr:nth-child(2) {
      margin-left:5px;    /* adjust between 4‚Äì10px */
    }

    /* Code ‚Üí slightly left */
    .keygrid .hdr:nth-child(3) {
      margin-left:-6px;   /* adjust between -4px and -10px */
    }

    /* Qty ‚Üí slightly right */
    .keygrid .hdr:nth-child(4) {
      margin-left:6px;    /* adjust between 4‚Äì10px */

    }
    .keyrow {
      display:grid;
      grid-template-columns: 1.2fr 1.8fr 1.2fr .6fr;
      gap:8px;
      align-items:center;
      cursor:pointer;

      /* one solid row box */
      padding:12px 14px;
      border:1px solid #1e1e1e;
      border-radius:12px;
      background:#0e0e0e;
    }
    .keycell {
      /* no individual boxes ‚Äî just text inside the row box */
      padding:0;
      border:0;
      background:transparent;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .keycell.qty {
      text-align:right;
    }
    .keyrow.selected {
      border-color: var(--accent);
      background:#0b0b0b;
    }
    
        /* Doors grid (same look; 3 columns) */
    .doorgrid {
      display:grid;
      grid-template-columns: 1.2fr 1.8fr 1.5fr;
      gap:8px;
      align-items:center;
      position:sticky;
      top:0;
      z-index:2;
      background:#0e0e0e;
    }
    .doorgrid .hdr { font-weight:600; }


    /* shift the "Part Number" header text slightly left (without moving column) */
    .doorgrid .hdr:nth-child(3) {
      margin-left:-8px;   /* tweak this number (e.g. -6px to -12px) for perfect alignment */
    }

    /* shift the "Description" header slightly right (without moving column) */
    .doorgrid .hdr:nth-child(2) {
      margin-left:4px;   /* adjust between 4‚Äì10px until it lines up visually */
    }


    .doorrow {
      display:grid;
      grid-template-columns: 1.2fr 1.8fr 1.2fr;
      gap:8px;
      align-items:center;
      cursor:pointer;
      padding:12px 14px;
      border:1px solid #1e1e1e;
      border-radius:12px;
      background:#0e0e0e;
    }
    .doorcell { padding:0; border:0; background:transparent; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .doorrow.selected { border-color: var(--accent); background:#0b0b0b; }
    
    /* Active tab highlight */
    .tabbtn.active {
      color: var(--accent);
      border-color: var(--accent);
      background:#0b0b0b;
    }

    /* Coding Tree sub-tabs reuse tabbtn look */
    .subtabbtn {
      padding:6px 10px;
      border:1px solid #1e1e1e;
      border-radius:10px;
      background:#0a0a0a;
      color:var(--fg);
      cursor:pointer;
    }
    .subtabbtn.active {
      color: var(--accent);
      border-color: var(--accent);
      background:#0b0b0b;
    }

    
    .pinGrid {
      display:grid;
      grid-auto-rows:minmax(28px,auto);
      gap:6px;
      align-items:center;
      width:max-content;
    }
    .pinHdr, .pinCell {
      padding:8px 10px;
      border:1px solid #1e1e1e;
      border-radius:10px;
      background:#0e0e0e;
      white-space:nowrap;
    }
    .pinHdr { font-weight:600; }
    .kgTable {
      border-collapse:separate;  /* fix sticky-gap glitch */
      border-spacing:0;
      table-layout:fixed;        /* even column widths for keys */
    }

    /* Freeze top header row (Doors ‚Üì + key stampings) inside scroll area */
    .kgTable tr:first-child th {
      position:sticky;
      top:0;
      z-index:3;
      background:#0e0e0e;
    }
    .kgTable tr:first-child th:first-child {
      z-index:4;                 /* keep top-left cell above others */
    }

    /* Key headers (keys) ‚Äì fixed width, no ellipsis */
    .kgTable th:not(:first-child) {
      max-width:70px;
      min-width:70px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:clip;
      text-align:center;
    }



    /* Key cells (checkbox column) ‚Äì same width as headers */
    .kgTable td:not(:first-child) {
      width:70px;
      text-align:center;
    }

    /* Lock first column (Doors \ Keys + door stampings) */
    .kgTable th:first-child,
    .kgTable td:first-child {
      position:sticky;
      left:0;
      z-index:2;
      background:#0e0e0e;  /* same as card bg so it blends */
    }
    .kgTable th:first-child {
      z-index:3;           /* keep header above cells when scrolling */
    }

    /* Keying grid checkboxes ‚Äì view mode (green + not clickable) */
    .kgCB.viewmode {
      pointer-events:none;       /* can‚Äôt click */
      accent-color:#00c060;
      opacity:1;                 /* no grey fade */
      cursor:default;
    }






  </style>
</head>
<body>
  <!-- Main Screen -->
    <div id="mainScreen"
     style="display:flex;flex-direction:column;justify-content:center;align-items:center;
            height:100vh;text-align:center;background:transparent;">

    <h1 style="font-size:38px;margin-bottom:40px;color:#00ff90;font-weight:700;">
      Welcome to CodeGen V5.5.1
    </h1>

    <div style="display:flex;flex-direction:column;gap:16px;width:200px;">
      <button id="goCreate"
              class="primary"
              style="padding:14px 20px;font-size:17px;border-radius:14px;font-weight:600;">
        Create System
      </button>
      <button id="goLoad"
              style="background:#111;border:1px solid #333;color:#e0e0e0;
                     padding:14px 20px;font-size:17px;border-radius:14px;">
        Load System
      </button>
      <button id="goManager"
              style="background:#111;border:1px solid #333;color:#e0e0e0;
                     padding:14px 20px;font-size:17px;border-radius:14px;">
        System Manager
      </button>
    </div>


    <footer style="position:absolute;bottom:20px;color:#666;font-size:13px;">
      ¬© 2025 CodeGen Systems
    </footer>
  </div>

  <!-- Load Screen -->
  <div id="loadScreen" class="wrap" style="display:none;min-height:100vh;flex-direction:column;">
    <h1>Load System</h1>

    <div id="loadList"
         class="card"
         style="flex:1 1 auto;overflow:auto;padding:0;display:flex;flex-direction:column;">
      <!-- rows rendered by JS -->
    </div>

    <div class="btnbar" style="justify-content:flex-end;position:sticky;bottom:0;background:#0e0e0e;padding:12px;border-radius:12px;margin-top:12px;">
      <button id="returnMainFromLoad">Return to Main</button>
      <button id="openSystem" class="primary" disabled>Open System</button>
    </div>
    <div style="height:60px;"></div>
  </div>


  <!-- System Manager Screen -->
  <div id="managerScreen" class="wrap" style="display:none;min-height:100vh;flex-direction:column;">
    <h1>System Manager</h1>

    <div id="managerList"
         class="card"
         style="flex:1 1 auto;overflow:auto;padding:0;display:flex;flex-direction:column;">
      <!-- rows rendered by JS -->
    </div>

    <div class="btnbar" style="justify-content:flex-end;position:sticky;bottom:0;background:#0e0e0e;padding:12px;border-radius:12px;margin-top:12px;">
      <button id="btnImport">Import Systems</button>
      <button id="btnBackup">Backup Systems</button>
      <button id="btnDelete" class="warn">Delete System</button>
      <button id="returnMainFromManager" class="primary">Return to Main</button>
    </div>
    <div style="height:60px;"></div>
  </div>

  <!-- System Screen -->
  <div id="systemScreen" class="wrap" style="display:none;min-height:100vh;">
    <h1>
      <span id="sysViewId" style="font-weight:700;letter-spacing:.5px;"></span>
      <span style="color:#888;margin:0 6px;">‚Äì</span>
      <span id="sysViewDesc" class="muted" style="font-size:18px;"></span>
    </h1>



    <div class="card" style="margin-top:8px;">
      <div class="inline" style="justify-content:space-between; width:100%; flex-wrap:wrap; gap:10px;">
        <div class="btnbar" style="margin-top:0">
          <button id="btnSysKeys"  class="tabbtn">Keys</button>
          <button id="btnSysDoors" class="tabbtn">Doors</button>
          <button id="btnSysTree"  class="tabbtn">Coding Tree</button>
          <button id="btnSysNotes" class="tabbtn">Notes</button>
          <button id="btnSysKeyingGrid" class="tabbtn">Keying</button>
          <button id="btnSysCodingCheck" class="tabbtn">Coding Check</button>
          <button id="btnSysClose">Close System</button>
        </div>
      </div>
    </div>


    <div id="systemContent" class="card" style="min-height:120px;">
      <div class="muted">Choose an option above.</div>
    </div>
  </div>

  <!-- Create Screen -->
  <div id="createScreen" class="wrap" style="display:none">
    <h1>Create System <span class="tag">TMK ‚Üí MK ‚Üí CK</span></h1>


    <div class="card">
      <div class="row">

        <div>
          <label for="tmk" style="font-size:16px;font-weight:600;color:#ffffff;">TMK</label>
          <input id="tmk" type="text" inputmode="numeric" placeholder="Example: 53142">
        </div>
        <div>
          <label for="array" style="font-size:16px;font-weight:600;color:#ffffff;">Array</label>
          <input id="array" type="text" placeholder="Example: M00MC">
          <div class="hint"><b>M</b>=Master Key, <b>C</b>=Change Key, <b>0</b>=Empty</div>
        </div>
      </div>

      <div class="btnbar">
        <button id="r5">üé≤ R5</button>
        <button id="r6">üé≤ R6</button>
        <button class="primary" id="build">Build Coding Tree</button>
        <button id="assist">Coding Assist</button>
        <button id="clear">Clear</button>
        <button id="reduce">Reduce Errors</button>
      </div>
    </div>

    <div class="card">
      <div class="inline">
        <strong>Output</strong>
        <span class="tag" id="stats">‚Äî</span>
      </div>
      <div id="out" class="out" aria-live="polite"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div>
      <div class="btnbar">
        <button id="copy">Copy</button>
        <button id="returnMain">Return to Main</button>
        <button id="saveSystem" class="primary">Save System</button>
        <button id="helpBtn">Help</button>
      </div>
      <div class="footer">Rules enforced: Maximum Adjacent Cut &gt; 7 (MAC), Deepest First Cut ‚â• 8 (DFC) and Minimum Code Variation ‚â• 3 (MCV). Depth Step of Two.</div>
    </div>
  </div>

    <!-- Array Assist Modal -->
  <div id="assistModal" class="modal" hidden>
    <div class="backdrop" id="assistBackdrop"></div>
    <div class="dialog">
      <h3>Coding Assist</h3>
      <p class="muted" style="margin:6px 0 10px 0;">
        Enter the system's size below. We‚Äôll build the system to meet your requirements.
      </p>

      <div class="btnbar seg" style="margin-top:6px; justify-content:flex-start;">
        <button id="assistPin5">5 Pin</button>
        <button id="assistPin6">6 Pin</button>
      </div>
      
      <div class="row">
        <div>
          <label for="assistMk">Master Keys</label>
          <input id="assistMk" type="number" inputmode="numeric" min="0" step="1" placeholder="e.g. 5">
        </div>
        <div>
          <label for="assistCk">Change Keys</label>
          <input id="assistCk" type="number" inputmode="numeric" min="0" step="1" placeholder="e.g. 30">
        </div>
      </div>

      <div class="btnbar">
        <button id="assistCancel">Cancel</button>
        <button class="primary" id="assistDone">Done</button>
      </div>
    </div>
  </div>

    <!-- Reduce Errors ‚Äì Confirm -->
  <div id="reduceConfirm" class="modal" hidden>
    <div class="backdrop" id="reduceConfirmBackdrop"></div>
    <div class="dialog">
      <h3>Reduce Errors</h3>
      <p class="muted" style="margin:6px 0 12px 0;">
        <strong>Please Note:</strong> This will change the current TMK. Press <b>Start</b> to continue. You can run this multiple times until satisfied.
      </p>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="reduceCancel">Cancel</button>
        <button class="primary" id="reduceStart">Start</button>
      </div>
    </div>
  </div>

  <!-- Reduce Errors ‚Äì Result -->
  <div id="reduceResult" class="modal" hidden>
    <div class="backdrop" id="reduceResultBackdrop"></div>
    <div class="dialog">
      <h3>Processing Complete</h3>
      <pre id="reduceSummary" style="background:#060606;border:1px solid #101010;border-radius:12px;padding:10px;white-space:pre-wrap;margin:8px 0 12px 0;"></pre>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="reduceResultCancel">Cancel</button>
        <button class="primary" id="reduceAccept">Accept</button>
      </div>
    </div>
  </div>

  <!-- Save System Modal -->
  <div id="saveModal" class="modal" hidden>
    <div class="backdrop" id="saveBackdrop"></div>
    <div class="dialog">
      <h3>Save System</h3>
      <div class="row">
        <div>
          <label for="sysNumber">System Number</label>
          <input id="sysNumber" type="text" placeholder="SYS0001">
        </div>
        <div>
          <label for="sysDescription">System Description</label>
          <input id="sysDescription" type="text" placeholder="e.g. North Wing ‚Äì 5-pin">
        </div>
      </div>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="saveCancel">Cancel</button>
        <button class="primary" id="saveOk">OK</button>
      </div>
    </div>
  </div>

  <!-- Key Editor Modal -->
  <div id="keyModal" class="modal" hidden>
    <div class="backdrop" id="keyBackdrop"></div>
    <div class="dialog">
      <h3>Add / Edit Key</h3>
      <div class="row">
        <div>
          <label for="keyStamping">Key Stamping</label>
          <input id="keyStamping" type="text" placeholder="e.g. G01">
        </div>
        <div>
          <label for="keyDesc">Key Description</label>
          <input id="keyDesc" type="text" placeholder="e.g. Front Door Key">
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label for="keyCodeDisplay">Assigned Code</label>
          <input id="keyCodeDisplay" type="text" placeholder="No Code Assigned" readonly>
        </div>
      </div>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="keyCancel">Cancel</button>
        <button id="keyAssignOpen">Assign Code</button>
        <button class="primary" id="keySave">Save</button>
      </div>
    </div>
  </div>

  <!-- Assign Code Modal -->
  <div id="assignModal" class="modal" hidden>
    <div class="backdrop" id="assignBackdrop"></div>
    <div class="dialog">
      <h3>Assign Code</h3>
      <div id="assignTree"
           class="out"
           style="max-height:50vh; overflow:auto; margin-top:8px;"></div>
       <div class="btnbar" style="justify-content:flex-end">
         <button id="assignCancel">Cancel</button>
         <button id="assignManual">‚úèÔ∏è</button>
         <button id="assignToggleErr">Show Errors</button>
         <button class="primary" id="assignOk">Assign</button>
       </div>
     </div>
   </div>
   
   <!-- Manual Code Modal -->
   <div id="manualCodeModal" class="modal" hidden>
     <div class="backdrop" id="manualCodeBackdrop"></div>
     <div class="dialog">
       <h3>Manual Code</h3>
       <div class="row">
         <div style="flex:1">
           <label for="manualCodeInput">Manual Code</label>
           <input id="manualCodeInput" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Enter code">
         </div>
       </div>
       <div class="btnbar" style="justify-content:flex-end">
         <button id="manualCodeCancel">Cancel</button>
         <button class="primary" id="manualCodeOk">Assign</button>
       </div>
     </div>
   </div>

   <!-- Assign Code Warning Modal -->
   <div id="assignWarnModal" class="modal" hidden>
     <div class="backdrop" id="assignWarnBackdrop"></div>
     <div class="dialog">
       <h3>Change Assigned Code?</h3>
       <p class="muted" style="margin:8px 0 16px 0;">
         This key has previously been cut. Are you sure you want to change the code?
       </p>
       <div class="btnbar" style="justify-content:flex-end">
         <button class="primary" id="assignWarnNo">No</button>
         <button id="assignWarnYes" style="background:var(--warn); border-color:#ff5252; color:#ffffff;">Yes</button>
       </div>
     </div>
   </div>



  <!-- Confirm Delete Modal -->
  <div id="confirmDeleteModal" class="modal" hidden>
    <div class="backdrop" id="confirmDeleteBackdrop"></div>
    <div class="dialog">
      <h3>Are you sure you want to delete system?</h3>
      <div id="confirmDeleteLine" class="muted" style="margin:8px 0 12px 0;"></div>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="confirmDeleteCancel">Cancel</button>
        <button id="confirmDeleteGo" class="warn">Confirm Delete</button>
      </div>
    </div>
  </div>
  
   <!-- Cut Keys Modal -->
   <div id="cutKeyModal" class="modal" hidden>
     <div class="backdrop" id="cutKeyBackdrop"></div>
     <div class="dialog">
       <h3>Cut Keys</h3>
       <p class="muted" style="margin:6px 0 12px 0;">
         How many <strong id="cutKeyLabel">‚Äî</strong> keys would you like to cut?
       </p>
       <div class="row" style="margin-top:6px;">
         <div>
           <label for="cutQty">Quantity</label>
           <input id="cutQty" type="number" inputmode="numeric" min="1" step="1">
         </div>
       </div>
       <div class="btnbar" style="justify-content:flex-end">
         <button id="cutCancel">Cancel</button>
         <button class="primary" id="cutConfirm">Add</button>
       </div>
     </div>
   </div>

   <!-- Fast Build Modal -->
   <div id="fastBuildModal" class="modal" hidden>
     <div class="backdrop" id="fastBuildBackdrop"></div>
     <div class="dialog">
       <h3>Fast Build Keys</h3>
       <p class="muted" style="margin:6px 0 12px 0;">
         Please choose your preferences below. Fast Build will automatically generate the full key list from the coding tree while excluding any bad codes.
       </p>

       <div style="margin-top:4px;">
         <div class="muted" style="font-size:13px;margin-bottom:4px;">Key Stamping Conventions</div>
         <div class="btnbar seg" style="justify-content:flex-start;margin-top:4px;">
           <button id="fbConvNumeric">MK1 &amp; 1-1</button>
           <button id="fbConvAlpha">MKA &amp; A-1</button>
         </div>
       </div>

       <div style="margin-top:12px;">
         <div class="muted" style="font-size:13px;margin-bottom:4px;">Change Key Code Allocation</div>
         <div class="btnbar seg" style="justify-content:flex-start;margin-top:4px;">
           <button id="fbAllocSeq">Sequential</button>
           <button id="fbAllocRand">Random</button>
         </div>
       </div>

       <div class="btnbar" style="justify-content:flex-end;margin-top:16px;">
         <button id="fastBuildCancel">Cancel</button>
         <button class="primary" id="fastBuildGo">Build Keys</button>
       </div>
     </div>
   </div>

   <!-- Delete Key Modal -->
   <div id="deleteKeyModal" class="modal" hidden>
    <div class="backdrop" id="deleteKeyBackdrop"></div>
    <div class="dialog">
      <h3>Delete Key</h3>
      <div id="deleteKeyLine" class="muted" style="margin:8px 0 12px 0;"></div>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="deleteKeyCancel">Cancel</button>
        <button id="deleteKeyConfirm" class="warn">Delete Key</button>
      </div>
    </div>
  </div>
  
  <!-- Message Modal -->
  <div id="msgModal" class="modal" hidden>
    <div class="backdrop" id="msgBackdrop"></div>
    <div class="dialog">
      <h3>Key Not Added</h3>
      <div id="msgLine" class="muted" style="margin:8px 0 12px 0;"></div>
      <div class="btnbar" style="justify-content:flex-end">
        <button class="primary" id="msgOk">OK</button>
      </div>
    </div>
  </div>
  
  
  <!-- Import Success Modal -->
  <div id="importModal" class="modal" hidden>
    <div class="backdrop" id="importBackdrop"></div>
    <div class="dialog">
      <h3>Import Success</h3>
      <div id="importMsg" class="muted" style="margin:8px 0 12px 0;"></div>
      <div class="btnbar" style="justify-content:flex-end">
        <button class="primary" id="importDone">Done</button>
      </div>
    </div>
  </div>


  <!-- Door Editor Modal -->
  <div id="doorModal" class="modal" hidden>
    <div class="backdrop" id="doorBackdrop"></div>
    <div class="dialog">
      <h3>Add / Edit Door</h3>
      <div class="row">
        <div>
          <label for="doorStamping">Stamping</label>
          <input id="doorStamping" type="text" placeholder="e.g. D01">
        </div>
        <div>
          <label for="doorDesc">Description</label>
          <input id="doorDesc" type="text" placeholder="e.g. Front Entry Door">
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label for="doorPart">Part Number</label>
          <input id="doorPart" type="text" placeholder="e.g. 570/201">
        </div>
        <div>
          <label for="doorNotes">Notes</label>
          <input id="doorNotes" type="text" placeholder="Any notes‚Ä¶">
        </div>
      </div>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="doorAddAnother">Add Another</button>
        <button id="doorCancel">Cancel</button>
        <button class="primary" id="doorSave">Save</button>
      </div>
    </div>
  </div>

 <!-- Door Keying Modal (select multiple keys from Keys list) -->
  <div id="doorKeyingModal" class="modal" hidden>
    <div class="backdrop" id="doorKeyingBackdrop"></div>
    <div class="dialog">
      <h3>Assign Keys to Door</h3>
      <div id="doorKeyingList" class="out" style="max-height:50vh; overflow:auto; margin-top:8px;"></div>
      <div class="btnbar" style="justify-content:flex-end; gap:8px;">
        <button id="doorKeyingCopy">Copy Keying</button>
        <button id="doorKeyingCancel">Cancel</button>
        <button class="primary" id="doorKeyingOk">Assign</button>
      </div>
    </div>
  </div>

  <!-- Copy Keying Modal -->
  <div id="copyKeyingModal" class="modal" hidden>
    <div class="backdrop" id="copyKeyingBackdrop"></div>
    <div class="dialog">
      <h3>Copy Keying</h3>
      <div id="copyKeyingList" class="out" style="max-height:50vh; overflow:auto; margin-top:8px;"></div>
      <div class="btnbar" style="justify-content:flex-end; gap:8px;">
        <button id="copyKeyingCancel">Cancel</button>
        <button id="copyKeyingApply">Copy keying to 0 selected</button>
      </div>
    </div>
  </div>

  <!-- Delete Door Modal -->
  <div id="deleteDoorModal" class="modal" hidden>
    <div class="backdrop" id="deleteDoorBackdrop"></div>
    <div class="dialog">
      <h3>Delete Door</h3>
      <div id="deleteDoorLine" class="muted" style="margin:8px 0 12px 0;"></div>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="deleteDoorCancel">Cancel</button>
        <button id="deleteDoorConfirm" class="warn">Delete Door</button>
      </div>
    </div>
  </div>
  
    <!-- Door Pinning Modal -->
  <div id="doorPinningModal" class="modal" hidden>
    <div class="backdrop" id="doorPinningBackdrop"></div>
    <div class="dialog">
      <h3 id="doorPinningTitle">Pinning</h3>
      <div id="pinningChart" class="out" style="margin-top:8px; overflow:auto;"></div>
      <div style="margin-top:12px;">
        <div class="muted" style="margin-bottom:6px;">Keys operating this door</div>
        <div id="pinningKeysList" style="max-height:30vh; overflow:auto; padding:0; border:0; background:transparent; text-align:left;"></div>
      </div>
      <div class="btnbar" style="justify-content:flex-end; margin-top:12px;">
        <button id="doorPinningClose">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Save Confirmation Modal -->
  <div id="saveConfirmModal" class="modal" hidden>
    <div class="backdrop" id="saveConfirmBackdrop"></div>
    <div class="dialog">
      <h3>System Saved</h3>
      <p class="muted">Your system has been saved.</p>
      <div class="btnbar" style="justify-content:flex-end">
        <button class="primary" id="saveConfirmOk">OK</button>
      </div>
    </div>
  </div>

  <!-- TMK Warning Modal -->
  <div id="tmkWarnModal" class="modal" hidden>
    <div class="backdrop" id="tmkWarnBackdrop"></div>
    <div class="dialog">
      <h3>TMK Already Used</h3>
      <p class="muted">TMK has been previously used in:</p>
      <div id="tmkWarnList" class="out" style="max-height:40vh; overflow:auto; margin-top:6px;"></div>
      <p class="muted" style="margin-top:10px;">Are you sure you want to continue?</p>
      <div class="btnbar" style="justify-content:flex-end; gap:8px; margin-top:12px;">
        <button class="primary" id="tmkWarnNo">No</button>
        <button id="tmkWarnYes" style="background:var(--warn); border-color:#ff5252; color:#ffffff;">Yes</button>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" class="modal" hidden>
    <div class="backdrop" id="helpBackdrop"></div>
    <div class="dialog">
      <h3>Help</h3>
      <p class="muted">To design a system manually enter TMK + Array and Tap Build Coding Tree. You can use R5 and R6 to auto generate the TMK either 5 Pin or 6 Pin. To design a system automatically use the Coding Assist Button and follow the prompts.</p>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="helpClose">Close</button>
      </div>
    </div>
  </div>








  <script>
    // ---------- Utility ----------
    const $ = s => document.querySelector(s);
    const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

    function showMessage(msg){
      const modal = document.getElementById('msgModal');
      const line  = document.getElementById('msgLine');
      const ok    = document.getElementById('msgOk');
      const bd    = document.getElementById('msgBackdrop');
      if (!modal || !line || !ok || !bd) {
        alert(msg);
        return;
      }
      line.textContent = msg;
      modal.hidden = false;

      function close(){
        modal.hidden = true;
        ok.onclick = null;
        bd.onclick = null;
      }

      ok.onclick = close;
      bd.onclick = close;
    }


    function hasMaxAdjacentCutError(arr){
      for (let i=0;i<arr.length-1;i++){
        if (Math.abs(arr[i]-arr[i+1])>7) return true;
      }
      return false;
    }
    function hasDeepestFirstCutError(arr){
      return arr[0] >= 8;
    }
    function generateRandomTMK(pinCount){
      // Retry until it passes both checks
      while(true){
        const tmk = Array.from({length: pinCount}, ()=>randInt(0,9));
        if (!hasMaxAdjacentCutError(tmk) && !hasDeepestFirstCutError(tmk)) {
          return tmk.join('');
        }
      }
    }
    function evenSet(exclude){ // 0,2,4,6,8 except 'exclude'
      const s=[0,2,4,6,8]; return s.filter(v=>v!==exclude);
    }
    function oddSet(exclude){ // 1,3,5,7,9 except 'exclude'
      const s=[1,3,5,7,9]; return s.filter(v=>v!==exclude);
    }
    // Min Variation Rule (MVR): require at least one pair of digits >= 3 apart.
    // If (max - min) < 3, it violates the rule => error (true).
    function hasMinVariationError(arr){
      if (!arr || !arr.length) return true;
      let min = 9, max = 0;
      for (let i=0;i<arr.length;i++){
        const v = arr[i];
        if (v < min) min = v;
        if (v > max) max = v;
      }
      return (max - min) < 3;
    }


    // ---------- Core generation (ported from your Python) ----------
    function buildCodingTree(tmkStr, arrayStr){
      const tmk = tmkStr.split('').map(d=>+d);
      const masterPos = [...arrayStr].map((c,i)=>c.toUpperCase()==='M'?i:-1).filter(i=>i>=0);
      const changePos = [...arrayStr].map((c,i)=>c.toUpperCase()==='C'?i:-1).filter(i=>i>=0);

      // Generate all Master Keys by varying the M positions with same-parity progressions (exclude original)
      const masterKeys = [];
      (function genMK(cuts, idx){
        if (idx >= masterPos.length){ masterKeys.push(cuts.slice()); return; }
        const pos = masterPos[idx];
        const orig = tmk[pos];
        const options = (orig % 2 === 0) ? evenSet(orig) : oddSet(orig);
        for (const depth of options){
          cuts[pos] = depth;
          genMK(cuts, idx+1);
        }
        cuts[pos] = orig;
      })(tmk.slice(), 0);

      // For each MK, generate all CKs by varying the C positions with same-parity progressions (exclude original)
      function genCKs(base){
        const res=[];
        (function rec(cuts, idx){
          if (idx >= changePos.length){ res.push(cuts.slice()); return; }
          const pos = changePos[idx];
          const orig = cuts[pos];
          const options = (orig % 2 === 0) ? evenSet(orig) : oddSet(orig);
          for (const depth of options){
            cuts[pos] = depth;
            rec(cuts, idx+1);
          }
          cuts[pos] = orig;
        })(base.slice(), 0);
        return res;
      }

      // Assemble printable lines and CSV rows
      const lines=[];
      const csvRows=[["Key","Code","Error"]];

      lines.push(`TMK   : ${tmkStr}`);
      lines.push(`Array : ${arrayStr}`);
      lines.push("");

      // Add TMK/Array at the top of CSV (after header)
      csvRows.push(["TMK", tmkStr, ""]);
      csvRows.push(["Array", String(arrayStr).toUpperCase(), ""]);

      // GMK appears only if Array contains an M; GMK equals TMK code
      if (/[Mm]/.test(arrayStr)) {
        lines.push(`GMK - ${tmkStr}`);
        lines.push("");
        csvRows.push(["GMK", tmkStr, ""]);
      }



      let mkCount=0, ckTotal=0, errorCount=0;
       if (masterPos.length === 0 && changePos.length === 0) {
        const ckAdj  = hasMaxAdjacentCutError(tmk);
        const ckDeep = hasDeepestFirstCutError(tmk);
        const ckMvr  = hasMinVariationError(tmk);
        let ckErrMsg = "";
        if (ckAdj && !ckDeep && !ckMvr) {
          ckErrMsg = "MAC Error";
        } else if (!ckAdj && ckDeep && !ckMvr) {
          ckErrMsg = "DFC Error";
        } else if (!ckAdj && !ckDeep && ckMvr) {
          ckErrMsg = "MCV Error";
        } else if (ckAdj && ckDeep && !ckMvr) {
          ckErrMsg = "MAC & DFC Error";
        } else if (!ckAdj && ckDeep && ckMvr) {
          ckErrMsg = "DFC & MCV Error";
        }
        if (ckErrMsg) errorCount++;
        ckTotal = 1;


        // Match your CK line format (four leading spaces, pad label to 8)
        const ckLabel = 'CK1.1';
        lines.push(`    ${ckLabel.padEnd(8)} - ${tmkStr}${ckErrMsg?("  " + ckErrMsg):""}`);
        csvRows.push([ckLabel, tmkStr, ckErrMsg]);
        lines.push("");

        return { lines, csvRows, mkCount, ckTotal, errorCount };
      }

      masterKeys.forEach((mkCuts, i)=>{
        mkCount++;
        const mkLabel = `MK${i+1}`;
        const mkErrAdj  = hasMaxAdjacentCutError(mkCuts);
        const mkErrDeep = hasDeepestFirstCutError(mkCuts);
        const mkErrMvr  = hasMinVariationError(mkCuts);
        const mkErrMsg = [ mkErrAdj && "MAC Error", mkErrDeep && "DFC Error", mkErrMvr && "MCV Error" ]
                           .filter(Boolean).join(" & ");

        if (mkErrMsg) errorCount++;

        const mkCode = mkCuts.join("");


        lines.push(`%c${mkLabel} - ${mkCode}${mkErrMsg?("  " + mkErrMsg):""} %c`.trim());
        csvRows.push([mkLabel, mkCode, mkErrMsg]);

        const cks = genCKs(mkCuts);
        cks.forEach((ckCuts, j)=>{
          ckTotal++;
          const ckLabel = `CK${i+1}.${(j+1)}`;
          const ckCode = ckCuts.join("");
          // CK error carries MK adjacent error OR own adjacent; + own deepest-first + MVR
          const ckAdj  = hasMaxAdjacentCutError(ckCuts);
          const ckDeep = hasDeepestFirstCutError(ckCuts);
          const ckMvr  = hasMinVariationError(ckCuts);
          let ckErrMsg = "";
          if (ckAdj && !ckDeep && !ckMvr) {
            ckErrMsg = "MAC Error";
          } else if (!ckAdj && ckDeep && !ckMvr) {
            ckErrMsg = "DFC Error";
          } else if (!ckAdj && !ckDeep && ckMvr) {
            ckErrMsg = "MCV Error";
          } else if (ckAdj && ckDeep && !ckMvr) {
            ckErrMsg = "MAC & DFC Error";
          } else if (!ckAdj && ckDeep && ckMvr) {
            ckErrMsg = "DFC & MCV Error";
          }

          if (ckErrMsg) errorCount++;


          lines.push(`    ${ckLabel.padEnd(8)} - ${ckCode}${ckErrMsg?("  " + ckErrMsg):""}`);
          csvRows.push([ckLabel, ckCode, ckErrMsg]);

        });

        lines.push(""); // spacer between MK groups
      });

      return { lines, csvRows, mkCount, ckTotal, errorCount };
    }

    // --- Reduce Errors helpers (global) ---
    function variationScoreFromTMK(tmkStr){
      // Higher variation between adjacent cuts preferred
      const d = tmkStr.split('').map(n=>+n);
      let s = 0;
      for (let i=0;i<d.length-1;i++) s += Math.abs(d[i]-d[i+1]);
      return s;
    }

    function evaluateTMK(tmkStr, arrayStr){
      const { errorCount } = buildCodingTree(tmkStr, arrayStr);
      return {
        tmk: tmkStr,
        errors: errorCount,
        varScore: variationScoreFromTMK(tmkStr)
      };
    }
    
    function showImportSuccess(msg){
      const modal = document.getElementById('importModal');
      const text  = document.getElementById('importMsg');
      const done  = document.getElementById('importDone');
      const bd    = document.getElementById('importBackdrop');

      text.textContent = msg;
      modal.hidden = false;

      function close(){
        modal.hidden = true;
        done.onclick = null;
        bd.onclick = null;
      }

      done.onclick = close;
      bd.onclick = close;
    }



    // ---------- UI wiring ----------
    let outEl = $('#out');
const statsEl = $('#stats');

// Reusable: turn coding lines into coloured HTML
function codingLinesToHTML(lines){
  return lines.map(line=>{
    const hasErr = /(?:MAC|DFC|MCV)\s*Error/.test(line); // catches Errors

    if (line.startsWith('%cMK')) {
      // MK line with style markers
      const safe = line
          .replace(/%c/g,'')
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;');

      if (hasErr) {
        // Whole MK line red (label + code + error)
        return `<span class="err">${safe}</span>`;
      } else {
        // MK label cyan, rest normal
        const [head, ...rest] = safe.split('  ');
        const tail = rest.join('  ');
        return `<span class="mk">${head}</span>${tail ? `  ${tail}` : ''}`;
      }

    } else if (line.startsWith('GMK -')) {
      const esc = line
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;');
      return `<span class="tmk">${esc}</span>`;

    } else if (line.startsWith('TMK   :')) {
      const esc = line
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;');
      return esc;

    } else {
      // CK lines and any other lines
      const esc = line
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;');
      return hasErr ? `<span class="err">${esc}</span>` : esc;
    }
  }).join('\n');
}

// Keep Create screen behaviour
function printLines(lines){
  outEl.innerHTML = codingLinesToHTML(lines);
}


    function toCSV(rows){
      return rows.map(r=>r.map(v=>{
        const s = (v==null?'':String(v));
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');
    }

    $('#r5').onclick = ()=>{
      const r = generateRandomTMK(5);
      $('#tmk').value = r;
    };
    $('#r6').onclick = ()=>{
      const r = generateRandomTMK(6);
      $('#tmk').value = r;
    };

        // Force uppercase as user types in the Array input
    document.getElementById('array').addEventListener('input', e => {
      const cursor = e.target.selectionStart;
      e.target.value = e.target.value.toUpperCase();
      e.target.setSelectionRange(cursor, cursor);
    });


        // ---------- Array Assist (modal) ----------
    function openAssist(){
      const modal = document.getElementById('assistModal');
      document.getElementById('assistMk').value = '';
      document.getElementById('assistCk').value = '';
      // reset pin selection
      window._assistPins = null;
      document.getElementById('assistPin5').classList.remove('selected');
      document.getElementById('assistPin6').classList.remove('selected');
      modal.hidden = false;
    }

    function closeAssist(){
      document.getElementById('assistModal').hidden = true;
    }
    // ceil(log4(x)), treating x <= 1 as 0
    function neededDesignations(x){
      const n = Number(x);
      if (!isFinite(n) || n <= 1) return 0;
      return Math.ceil(Math.log(n) / Math.log(4));
    }
    function buildArrayFromRequest(tmkStr, mkReq, ckReq){
      const N = tmkStr.length;
      const m = neededDesignations(mkReq);
            // Change Keys tweak: if user requests exactly 1 CK, force one 'C'
      let c = neededDesignations(ckReq);
      const ckNum = Number(ckReq);
      if (Number.isFinite(ckNum) && ckNum === 1) c = 1;
      
      if (m + c > N) {
        throw new Error(`Not enough chambers: need ${m+c}, have ${N}. Reduce requested counts.`);
      }
      // M...M C...C 0...0
      return '0'.repeat(N - m - c) + 'M'.repeat(m) + 'C'.repeat(c);
    }

    // Open modal
    document.getElementById('assist').onclick = openAssist;
    // Close actions
    document.getElementById('assistBackdrop').onclick = closeAssist;
    document.getElementById('assistCancel').onclick = closeAssist;

        // Pin size selection buttons
    document.getElementById('assistPin5').onclick = ()=>{
      window._assistPins = 5;
      document.getElementById('assistPin5').classList.add('selected');
      document.getElementById('assistPin6').classList.remove('selected');
    };
    document.getElementById('assistPin6').onclick = ()=>{
      window._assistPins = 6;
      document.getElementById('assistPin6').classList.add('selected');
      document.getElementById('assistPin5').classList.remove('selected');
    };

        // Done ‚Üí choose pin size, generate TMK, compute Array, auto-build
    document.getElementById('assistDone').onclick = ()=>{
      if (!window._assistPins){
        alert('Please select 5 Pin or 6 Pin.'); return;
      }
      const mkReq = document.getElementById('assistMk').value.trim();
      const ckReq = document.getElementById('assistCk').value.trim();
      if (mkReq==='' || ckReq===''){
        alert('Please enter both Master Keys and Change Keys.'); return;
      }
      try{
        // 1) Generate TMK for the chosen pin size
        const tmk = generateRandomTMK(window._assistPins);
        document.getElementById('tmk').value = tmk;

        // 2) Build Array and set it
        const arr = buildArrayFromRequest(tmk, mkReq, ckReq);
        document.getElementById('array').value = arr;

        // 3) Close modal and trigger Build
        closeAssist();
        document.getElementById('build').click();
      }catch(err){
        alert(err.message);
      }
    };

        // --- Reduce Errors flow ---
    const reduceConfirm = document.getElementById('reduceConfirm');
    const reduceResult = document.getElementById('reduceResult');
    const reduceSummary = document.getElementById('reduceSummary');

    function openReduceConfirm(){ reduceConfirm.hidden = false; }
    function closeReduceConfirm(){ reduceConfirm.hidden = true; }
    function openReduceResult(){ reduceResult.hidden = false; }
    function closeReduceResult(){ reduceResult.hidden = true; }

    // Open the confirm dialog
    document.getElementById('reduce').onclick = openReduceConfirm;
    document.getElementById('reduceConfirmBackdrop').onclick = closeReduceConfirm;
    document.getElementById('reduceCancel').onclick = closeReduceConfirm;

    // Close the result dialog by backdrop
    document.getElementById('reduceResultBackdrop').onclick = closeReduceResult;

    // Cancel on result => rebuild from original TMK
    document.getElementById('reduceResultCancel').onclick = ()=>{
      if (window._reduceOrigTMK && window._reduceOrigArr) {
        document.getElementById('tmk').value = window._reduceOrigTMK;
        document.getElementById('array').value = window._reduceOrigArr;
        document.getElementById('build').click();
      }
      closeReduceResult();
    };

    // Accept => set best TMK and build
    document.getElementById('reduceAccept').onclick = ()=>{
      if (window._reduceBest && window._reduceBest.tmk) {
        document.getElementById('tmk').value = window._reduceBest.tmk;
        document.getElementById('build').click();
      }
      closeReduceResult();
    };

    // Start the 10-trial search
    document.getElementById('reduceStart').onclick = ()=>{
      // Close confirm
      closeReduceConfirm();

      // Gather + validate current inputs
      const tmk = document.getElementById('tmk').value.trim();
      const arrRaw = document.getElementById('array').value.trim().replace(/\s+/g,'');
      const arrNorm = arrRaw.replace(/[oO]/g,'0').toUpperCase();

      if (!/^\d+$/.test(tmk) || tmk.length===0){ alert('Check TMK is Numbers Only.'); return; }
      if (arrNorm.length !== tmk.length){ alert('Array length must match TMK length.'); return; }
      if (!/^[MC0]+$/.test(arrNorm)){ alert('Array must contain only M, C, or 0.'); return; }
      if (arrNorm.includes('M') && !arrNorm.includes('C')) {
        alert('Array Incorrect. Master Keys can only be created if they have Change Keys underneath. Please add C into the Array to continue.');
        return;
      }

      // Remember the current state (for Cancel or if already optimal)
      window._reduceOrigTMK = tmk;
      window._reduceOrigArr = arrNorm;

      // Evaluate current TMK ("before")
      const before = evaluateTMK(tmk, arrNorm);

      // Choose pin length for trials using current TMK length (5 or 6)
      const N = tmk.length;

      // Run trial in reduce errors
      const trials = 1000;
      const candidates = [before];
      for (let i=0;i<trials;i++){
        const candTMK = generateRandomTMK(N);
        const cand = evaluateTMK(candTMK, arrNorm);
        candidates.push(cand);
      }

      // Pick the best: lowest errors; tie-breaker: RANDOM among equals
      const minErr = Math.min(...candidates.map(c => c.errors));
      const pool = candidates.filter(c => c.errors === minErr);
      const best = pool[Math.floor(Math.random() * pool.length)];

      window._reduceBest = best; // stash for Accept


      // Build summary text
      const pad = (s,w)=>String(s).padEnd(w,' ');
      const beforeLine1 = `TMK: ${before.tmk}`;
      const afterLine1  = `TMK: ${best.tmk}`;
      const beforeLine2 = `Errors: ${before.errors}`;
      const afterLine2  = `Errors: ${best.errors}`;

      reduceSummary.textContent =
`Before                After:
${pad(beforeLine1,22)}${afterLine1}
${pad(beforeLine2,22)}${afterLine2}`;

      // Show result modal with Cancel/Accept
      openReduceResult();
    };


    $('#clear').onclick = ()=>{
      $('#tmk').value = '';
      $('#array').value = '';
      outEl.innerHTML = '<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>';
      statsEl.textContent = '‚Äî';
    };

        $('#build').onclick = ()=>{
      // üîß Hard clear output window before rebuilding
      const freshOut = outEl.cloneNode(false); // clone without children
      outEl.parentNode.replaceChild(freshOut, outEl);
      outEl = freshOut;                        // update reference for printLines

      statsEl.textContent = '‚Äî';
      window._lastCSV = undefined;
      window._lastText = undefined;

      const tmk = $('#tmk').value.trim();
      const arrRaw = $('#array').value.trim().replace(/\s+/g,'');
      const arrNorm = arrRaw.replace(/[oO]/g,'0').toUpperCase();

      if (!/^\d+$/.test(tmk) || tmk.length===0){ alert('Check TMK is Numbers Only.'); return; }
      if (arrNorm.length !== tmk.length){ alert('Array length must match TMK length.'); return; }
      if (!/^[MC0]+$/.test(arrNorm)){ alert('Array must contain only M, C, or 0.'); return; }
                // Rule: M cannot exist without at least one C
      if (arrNorm.includes('M') && !arrNorm.includes('C')) {
        alert('Array Incorrect. Master Keys can only be created if they have Change Keys underneath. Please add C into the Array to continue.');
        return;
      }


      const {lines, csvRows, mkCount, ckTotal, errorCount} = buildCodingTree(tmk, arrNorm);
      printLines(lines);
      statsEl.textContent = `TMK ${tmk.length} Pin ¬∑ MKs ${mkCount} ¬∑ CK ${ckTotal} ¬∑ Errors ${errorCount}`;

      // stash for copy/save
      window._lastCSV = toCSV(csvRows);
      window._lastText = lines.join('\n');
      window._lastRows = csvRows;
      window._lastTMK = tmk;
      window._lastArray = arrNorm;
      window._lastStats = { mkCount, ckTotal, errorCount, pins: tmk.length };
    };




    $('#copy').onclick = async ()=>{
      if (!window._lastText){ alert('Build first.'); return; }
      try{
        await navigator.clipboard.writeText(window._lastText);
        alert('Copied results to clipboard.');
      }catch{
        // fallback
        const ta = document.createElement('textarea');
        ta.value = window._lastText;
        document.body.appendChild(ta);
        ta.select(); document.execCommand('copy');
        document.body.removeChild(ta);
        alert('Copied results to clipboard.');
      }
    };

    // Save System flow
    $('#saveSystem').onclick = ()=>{
      if (!window._lastText || !window._lastRows){ alert('Build first.'); return; }
      const { nextId } = getNextSystemId();
      document.getElementById('sysNumber').value = nextId;   // auto-fill (editable)
      document.getElementById('sysDescription').value = '';  // user can type anything
      openSaveModal();
    };



    // Keep offline functionality
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    }

    // ---- Save System (modal + storage) ----
    function openSaveModal(){ document.getElementById('saveModal').hidden = false; }
    function closeSaveModal(){ document.getElementById('saveModal').hidden = true; }

    // iOS Safari bookmark/PWA: localStorage persists in standalone mode.
    function getSystems(){
      try {
        const raw = localStorage.getItem('codegen_systems');
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }
    function setSystems(list){
      localStorage.setItem('codegen_systems', JSON.stringify(list || []));
    }
    function getNextSystemId(){
      const systems = getSystems();
      let max = 0;
      for (const s of systems){
        const m = /^SYS(\d{4})$/.exec(s && s.id ? s.id : '');
        if (m) max = Math.max(max, parseInt(m[1],10));
      }
      const nextNum = max + 1;
      const nextId = 'SYS' + String(nextNum).padStart(4,'0');
      return { nextId, nextNum };
    }

    let _pendingSaveSystem = null;
    let _pendingSaveId = null;

    // Modal wiring
    document.getElementById('saveBackdrop').onclick = closeSaveModal;
    document.getElementById('saveCancel').onclick = closeSaveModal;
    document.getElementById('saveOk').onclick = ()=>{
      const id = (document.getElementById('sysNumber').value || '').trim() || getNextSystemId().nextId;
      const description = (document.getElementById('sysDescription').value || '').trim();

      // Build object to persist (rich JSON)
      const system = {
        id,
        description,
        tmk: window._lastTMK,
        array: window._lastArray,
        stats: window._lastStats,
        lines: window._lastText ? window._lastText.split('\n') : [],
        rows: window._lastRows || []
      };

      const systems = getSystems();
      const existingIdx = systems.findIndex(s => s.id === id);
      const isNew = existingIdx < 0;

      const matches = systems.filter(s => s && s.tmk === system.tmk && s.id !== id);

      if (isNew && matches.length > 0){
        _pendingSaveSystem = system;
        _pendingSaveId = id;

        const listEl = document.getElementById('tmkWarnList');
        if (listEl){
          let html = '<div style="display:flex;flex-direction:column;gap:4px;">';
          matches.forEach(m=>{
            const desc = (m.description || '').trim();
            html += `<div><strong>${m.id}</strong>${desc ? ' ‚Äî ' + desc : ''}</div>`;
          });
          html += '</div>';
          listEl.innerHTML = html;
        }

        const warnModal = document.getElementById('tmkWarnModal');
        const warnBd    = document.getElementById('tmkWarnBackdrop');
        if (warnModal) warnModal.hidden = false;
        if (warnBd) warnBd.hidden = false;

        return;
      }

      const idx = systems.findIndex(s => s.id === id);
      if (idx >= 0) systems[idx] = system; else systems.push(system);
      setSystems(systems);

      closeSaveModal();
      // open UI confirmation window
      document.getElementById('saveConfirmModal').hidden = false;
      document.getElementById('saveConfirmBackdrop').hidden = false;

    };



    // ---- Screen Navigation ----
    const mainScreen    = document.getElementById('mainScreen');
    const createScreen  = document.getElementById('createScreen');
    const loadScreen    = document.getElementById('loadScreen');
    const systemScreen  = document.getElementById('systemScreen');
    const managerScreen = document.getElementById('managerScreen');

    const loadListEl    = document.getElementById('loadList');
    const openBtn       = document.getElementById('openSystem');
    const managerListEl = document.getElementById('managerList');

    // system header els
    const sysViewId   = document.getElementById('sysViewId');
    const sysViewDesc = document.getElementById('sysViewDesc');

    let _selectedId = null;           // Load screen selection
    let _managerSelectedId = null;    // Manager screen selection
    let _currentSystem = null;



    function showMain(){
      mainScreen.style.display    = 'flex';
      createScreen.style.display  = 'none';
      loadScreen.style.display    = 'none';
      systemScreen.style.display  = 'none';
      managerScreen.style.display = 'none';
      window.scrollTo(0,0);
    }
    function showCreate(){
      mainScreen.style.display    = 'none';
      createScreen.style.display  = 'block';
      loadScreen.style.display    = 'none';
      systemScreen.style.display  = 'none';
      managerScreen.style.display = 'none';
      window.scrollTo(0,0);
    }
    function showLoad(){
      mainScreen.style.display    = 'none';
      createScreen.style.display  = 'none';
      systemScreen.style.display  = 'none';
      managerScreen.style.display = 'none';
      loadScreen.style.display    = 'flex';
      renderLoadList();
      window.scrollTo(0,0);
    }

    function showManager(){
      mainScreen.style.display    = 'none';
      createScreen.style.display  = 'none';
      loadScreen.style.display    = 'none';
      systemScreen.style.display  = 'none';
      managerScreen.style.display = 'flex';
      renderManagerList();
      window.scrollTo(0,0);
    }

    function showSystem(){
      mainScreen.style.display    = 'none';
      createScreen.style.display  = 'none';
      loadScreen.style.display    = 'none';
      managerScreen.style.display = 'none';
      systemScreen.style.display  = 'block';

      // default view = Notes (and highlight the Notes tab)
      const content = document.getElementById('systemContent');
      if (content && typeof renderNotesView === 'function') {
        renderNotesView();
      }
      const tabs = document.querySelectorAll('.tabbtn');
      tabs.forEach(b => b && b.classList.remove('active'));
      const notesBtn = document.getElementById('btnSysNotes');
      if (notesBtn) notesBtn.classList.add('active');

      window.scrollTo(0,0);
    }
    // --- Save Confirm Modal ---
    (function(){
      const modal = document.getElementById('saveConfirmModal');
      const bd    = document.getElementById('saveConfirmBackdrop');
      const ok    = document.getElementById('saveConfirmOk');

      function closeConfirm(){
        modal.hidden = true;
        bd.hidden = true;
        document.getElementById('clear').click();
        showMain();
      }
      if (bd) bd.onclick = closeConfirm;
      if (ok) ok.onclick = closeConfirm;
    })();

    (function(){
      const modal = document.getElementById('tmkWarnModal');
      const bd    = document.getElementById('tmkWarnBackdrop');
      const noBtn = document.getElementById('tmkWarnNo');
      const yesBtn = document.getElementById('tmkWarnYes');

      function closeWarn(){
        if (modal) modal.hidden = true;
        if (bd) bd.hidden = true;
      }

      if (bd) bd.onclick = ()=>{
        _pendingSaveSystem = null;
        _pendingSaveId = null;
        closeWarn();
      };

      if (noBtn) noBtn.onclick = ()=>{
        _pendingSaveSystem = null;
        _pendingSaveId = null;
        closeWarn();
      };

      if (yesBtn) yesBtn.onclick = ()=>{
        if (_pendingSaveSystem && _pendingSaveId){
          const systems = getSystems();
          const idx = systems.findIndex(s => s.id === _pendingSaveId);
          if (idx >= 0) systems[idx] = _pendingSaveSystem; else systems.push(_pendingSaveSystem);
          setSystems(systems);
        }

        _pendingSaveSystem = null;
        _pendingSaveId = null;

        closeWarn();
        closeSaveModal();
        const scm = document.getElementById('saveConfirmModal');
        const scb = document.getElementById('saveConfirmBackdrop');
        if (scm) scm.hidden = false;
        if (scb) scb.hidden = false;
      };
    })();

    
    // --- Help Modal ---
    (function(){
      const btn   = document.getElementById('helpBtn');
      const modal = document.getElementById('helpModal');
      const bd    = document.getElementById('helpBackdrop');
      const close = document.getElementById('helpClose');

      if (btn) btn.onclick = ()=>{
        modal.hidden = false;
        bd.hidden = false;
      };

      if (bd)    bd.onclick   = ()=>{ modal.hidden = true; bd.hidden = true; };
      if (close) close.onclick = ()=>{ modal.hidden = true; bd.hidden = true; };
    })();


    // --- Help Modal ---
    (function(){
      const btn   = document.getElementById('helpBtn');
      const modal = document.getElementById('helpModal');
      const bd    = document.getElementById('helpBackdrop');
      const close = document.getElementById('helpClose');

      if (btn) btn.onclick = ()=>{
        modal.hidden = false;
        bd.hidden = false;
      };

      if (bd)    bd.onclick   = ()=>{ modal.hidden = true; bd.hidden = true; };
      if (close) close.onclick = ()=>{ modal.hidden = true; bd.hidden = true; };
    })();





    // Main buttons
    document.getElementById('goCreate').onclick  = showCreate;
    document.getElementById('goLoad').onclick    = showLoad;
    document.getElementById('goManager').onclick = showManager;
    document.getElementById('returnMain').onclick = () => {
      document.getElementById('clear').click(); // clear the Create screen
      showMain();
    };

    // Load screen buttons
    document.getElementById('returnMainFromLoad').onclick = showMain;

    // Manager screen buttons
    document.getElementById('returnMainFromManager').onclick = showMain;

    // Import Systems (JSON or our "zip" JSON backups)
    document.getElementById('btnImport').onclick = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,.zip,application/json';

      input.onchange = (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const text = String(ev.target.result || '');
            const parsed = JSON.parse(text);

            let incoming = [];

            // single system object
            if (parsed && !Array.isArray(parsed) && parsed.id) {
              incoming = [parsed];
            }
            // array of systems
            else if (Array.isArray(parsed)) {
              incoming = parsed;
            }
            // wrapped form: { systems: [...] }
            else if (parsed && Array.isArray(parsed.systems)) {
              incoming = parsed.systems;
            }

            if (!incoming.length) {
              alert('No systems found in file.');
              return;
            }

            const current = getSystems();
            incoming.forEach(sys => {
              if (!sys || !sys.id) return;
              const idx = current.findIndex(s => s.id === sys.id);
              if (idx >= 0) {
                current[idx] = sys;   // update existing
              } else {
                current.push(sys);    // add new
              }
            });

            setSystems(current);
            renderManagerList();
            showImportSuccess(`Imported ${incoming.length} system(s).`);
          } catch (err) {
            console.error(err);
            alert('Failed to import file. Make sure it is a JSON backup from this app.');
          }
        };

        reader.readAsText(file);
      };

      input.click();
    };

    // Backup Systems (exports all systems into a single JSON-as-zip file)
    document.getElementById('btnBackup').onclick = () => {
      const systems = getSystems();
      if (!systems.length) {
        alert('No systems to backup.');
        return;
      }

      const payload = {
        exportedAt: new Date().toISOString(),
        count: systems.length,
        systems
      };

      const blob = new Blob(
        [JSON.stringify(payload, null, 2)],
        { type: 'application/json' }
      );

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      // use .zip extension so you can treat it as a "zip" backup
      a.download = 'codegen_backup.zip';

      document.body.appendChild(a);
      a.click();

      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    };



    // System screen buttons
    (function(){
      const btnClose       = document.getElementById('btnSysClose');
      const btnKeys        = document.getElementById('btnSysKeys');
      const btnDoors       = document.getElementById('btnSysDoors');
      const btnTree        = document.getElementById('btnSysTree');
      const btnNotes       = document.getElementById('btnSysNotes');
      const btnKeying      = document.getElementById('btnSysKeyingGrid');
      const btnCodingCheck = document.getElementById('btnSysCodingCheck');
      const content        = document.getElementById('systemContent');
      
      // ---- Keying Grid view (system-wide) ----
      function buildKeyParentMap(){
        const map = new Map();

        if (!_currentSystem || !_currentSystem.rows || !_currentSystem.rows.length) {
          return map;
        }

        const rows = _currentSystem.rows.slice();
        const body = rows.slice(1).filter(r => r && r.length >= 2);

        const labelToCode = new Map();

        body.forEach(r => {
          const label = String(r[0] || '').trim().toUpperCase();
          const code  = String(r[1] || '').trim();
          if (!label || !code) return;
          labelToCode.set(label, code);
        });

        const gmkCode = labelToCode.get('GMK') || null;

        body.forEach(r => {
          const rawLabel = String(r[0] || '').trim();
          const label    = rawLabel.toUpperCase();
          const code     = String(r[1] || '').trim();
          if (!label || !code) return;

          let parents = [];
          let m;

          if ((m = label.match(/^MK(\d+)$/))) {
            if (gmkCode) {
              parents.push(gmkCode);          // MK ‚Üí GMK
            }
          } else if ((m = label.match(/^CK(\d+)\.(\d+)$/))) {
            const mkIdx   = parseInt(m[1], 10);
            const mkLabel = 'MK' + mkIdx;
            const mkCode  = labelToCode.get(mkLabel) || null;

            if (mkCode) {
              parents.push(mkCode);           // CK ‚Üí MK
            }
            if (gmkCode) {
              parents.push(gmkCode);          // CK ‚Üí GMK as well
            }
          } else if (label === 'GMK') {
            // GMK has no parents
          } else {
            // Any other labels: no parents
          }

          map.set(code, parents);
        });

        return map;
      }

      function renderKeyingGrid(){
        if (!_currentSystem) return;
        ensureDoorsArray();
        ensureKeysArray();

        const content = document.getElementById('systemContent');
        if (!content) return;

        const doors = _currentSystem.doors || [];
        const keys  = _currentSystem.keys  || [];

        // build grid table
        let html = '';
        html += `
          <div style="max-height:60vh;overflow:auto; white-space:nowrap;">
            <table class="kgTable">
              <tr>
                <th class="hdr muted" style="padding:6px 12px;">Doors ‚Üì</th>
                ${keys.map(k=>`
                  <th class="hdr muted" style="padding:6px 12px;">${k.stamping||''}</th>
                `).join('')}
              </tr>

              ${doors.map((d,di)=>`
                <tr>
                  <td class="hdr" style="padding:6px 12px;">${d.stamping||''}</td>
                  ${keys.map((k,ki)=>{
                    const assigned = (d.keys||[]).includes(k.stamping||'');
                    const id = `kg_${di}_${ki}`;
                    return `
                      <td style="text-align:center; padding:4px;">
                        <input type="checkbox" class="kgCB viewmode" id="${id}" data-di="${di}" data-ki="${ki}" ${assigned?'checked':''}>
                      </td>`;
                  }).join('')}
                </tr>
              `).join('')}
            </table>
          </div>
          
          <div class="btnbar" style="justify-content:flex-end;margin-top:12px;">
            <button id="kgAddAbove" class="tabbtn" style="display:none;">Add Key Above</button>
            <button id="kgEdit" class="tabbtn">Edit</button>
            <button id="kgCancel" disabled>Cancel</button>
          </div>

        `;

        const codeParentMap = buildKeyParentMap();

        content.innerHTML = html;

        const btnEdit     = document.getElementById('kgEdit');
        const btnCancel   = document.getElementById('kgCancel');
        const btnAddAbove = document.getElementById('kgAddAbove');

        let editing      = false;
        let addAboveMode = false;

        if (btnAddAbove) {
          btnAddAbove.style.display = 'none';
          btnAddAbove.disabled = true;
          btnAddAbove.classList.remove('active');
        }

        // When a checkbox is changed in Edit mode with Add Key Above selected,
        // auto-tick parent keys (MK / GMK) for the same door.
        const allCbs = content.querySelectorAll('input.kgCB');
        allCbs.forEach(cb => {
          cb.onchange = () => {
            if (!editing || !addAboveMode || !cb.checked) return;

            const di = Number(cb.dataset.di);
            const ki = Number(cb.dataset.ki);
            const key = keys[ki];
            if (!key || !key.code) return;

            const code = String(key.code || '').trim();
            const parentCodes = codeParentMap.get(code);
            if (!parentCodes || !parentCodes.length) return;

            parentCodes.forEach(parentCode => {
              if (!parentCode) return;

              const parentIdx = keys.findIndex(k =>
                String(k.code || '').trim() === String(parentCode).trim()
              );
              if (parentIdx < 0) return;

              const pid = 'kg_' + di + '_' + parentIdx;
              const pcb = document.getElementById(pid);
              if (pcb) {
                pcb.checked = true;
              }
            });
          };
        });

        if (btnAddAbove) {
          btnAddAbove.onclick = () => {
            if (!editing) return;
            addAboveMode = !addAboveMode;
            btnAddAbove.classList.toggle('active', addAboveMode);
          };
        }

        btnEdit.onclick = ()=>{
          editing = !editing;

          const cbs = content.querySelectorAll('input.kgCB');
          cbs.forEach(cb=>{
            if (editing) {
              cb.classList.remove('viewmode');  // edit mode: clickable, normal look
            } else {
              cb.classList.add('viewmode');     // view mode: green + locked
            }
          });

          if (editing){
            btnEdit.textContent = 'Save';
            btnEdit.classList.add('primary'); // use existing green theme
            btnCancel.disabled = false;

            if (btnAddAbove) {
              btnAddAbove.style.display = 'inline-block';
              btnAddAbove.disabled = false;
              addAboveMode = true;                 // default ON when entering edit
              btnAddAbove.classList.add('active'); // highlight like other tabbtns
            }
          } else {
            // SAVE CHANGES
            const newDoors = JSON.parse(JSON.stringify(_currentSystem.doors||[]));

            const cbs2 = content.querySelectorAll('input.kgCB');
            cbs2.forEach(cb=>{
              const di = Number(cb.dataset.di);
              const ki = Number(cb.dataset.ki);
              const stamp = keys[ki]?.stamping || '';
              if (!newDoors[di].keys) newDoors[di].keys = [];

              if (cb.checked){
                if (!newDoors[di].keys.includes(stamp))
                  newDoors[di].keys.push(stamp);
              } else {
                newDoors[di].keys = newDoors[di].keys.filter(s=>s!==stamp);
              }
            });

            _currentSystem.doors = newDoors;
            persistCurrentSystem();

            btnEdit.textContent = 'Edit';
            btnEdit.classList.remove('primary');
            btnCancel.disabled = true;

            if (btnAddAbove) {
              addAboveMode = false;
              btnAddAbove.classList.remove('active');
              btnAddAbove.style.display = 'none';
              btnAddAbove.disabled = true;
            }

            renderKeyingGrid(); // reload clean
          }
        };



        btnCancel.onclick = ()=>{
          editing = false;
          btnEdit.textContent = 'Edit';
          btnEdit.classList.remove('primary');
          btnCancel.disabled = true;

          if (btnAddAbove) {
            addAboveMode = false;
            btnAddAbove.classList.remove('active');
            btnAddAbove.style.display = 'none';
            btnAddAbove.disabled = true;
          }

          renderKeyingGrid(); // revert to original
        };
      }

      
      function setActiveTab(name){
        const map = {
          keys   : btnKeys,
          doors  : btnDoors,
          tree   : btnTree,
          notes  : btnNotes,
          keying : btnKeying,
          coding : btnCodingCheck
        };
        [btnKeys, btnDoors, btnTree, btnNotes, btnKeying, btnCodingCheck]
          .forEach(b=>b && b.classList.remove('active'));
        if (map[name]) map[name].classList.add('active');
      }

      if (btnClose) btnClose.onclick = () => {
        _currentSystem = null;
        _codingCheckLastHtml = '';
        _codingCheckSortMode = 'key';
        showLoad();
      };


      if (btnKeys)        btnKeys.onclick        = ()=>{ renderKeysView();        setActiveTab('keys');   };
      if (btnDoors)       btnDoors.onclick       = ()=>{ renderDoorsView();       setActiveTab('doors');  };
      if (btnTree)        btnTree.onclick        = ()=>{ renderCodingTreeView();  setActiveTab('tree');   };
      if (btnNotes)       btnNotes.onclick       = ()=>{ renderNotesView();       setActiveTab('notes');  };
      if (btnKeying)      btnKeying.onclick      = ()=>{ renderKeyingGrid();      setActiveTab('keying'); };
      if (btnCodingCheck) btnCodingCheck.onclick = ()=>{ renderCodingCheckView(); setActiveTab('coding'); };
    })();




    // ---- Notes view (editable, auto-save) ----
    function renderNotesView(){
      if (!_currentSystem) return;
      const content = document.getElementById('systemContent');
      if (!content) return;

      const val = String(_currentSystem.notes || '');

      content.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px;">
          <label class="muted" style="font-size:16px; font-weight:600;">System Notes</label>
          <textarea id="systemNotesTA"
            style="width:100%; min-height:40vh; resize:vertical; padding:12px; border:1px solid #1e1e1e; border-radius:12px; background:#0e0e0e; color:var(--fg); font-size:16px; line-height:1.5;"
            placeholder="Type your notes here...">${val.replace(/</g,'&lt;')}</textarea>
          <div class="muted" id="notesSaveHint" style="font-size:12px;">Changes are saved automatically</div>
        </div>
      `;


      const ta = document.getElementById('systemNotesTA');
      const hint = document.getElementById('notesSaveHint');
      let t = null;

      ta.addEventListener('input', ()=>{
        if (t) clearTimeout(t);
        t = setTimeout(()=>{
          _currentSystem.notes = ta.value;
          persistCurrentSystem();
          if (hint){
            hint.textContent = 'Saved';
            setTimeout(()=>{ hint.textContent='Changes are saved automatically'; }, 1200);
          }
        }, 250);
      });
    }
    


  // ---- Coding Tree main view (with sub-tabs) ----
  function renderCodingTreeView(){
    if (!_currentSystem) return;
    const content = document.getElementById('systemContent');
    if (!content) return;

    content.innerHTML = `
      <div class="btnbar" style="margin-bottom:10px;">
        <button id="ctCodingOnly" class="subtabbtn active">Coding Only</button>
        <button id="ctShowKeys" class="subtabbtn">Show Keys</button>
        <input id="ctManualCode" type="text" inputmode="numeric" pattern="[0-9]*"
               style="width:120px;background:#0a0a0a;border:1px solid var(--border);border-radius:12px;padding:8px 10px;font-size:14px;color:var(--fg);" />
      </div>
      <div id="codingTreeHost" class="out" style="max-height:60vh; overflow:auto;"></div>
    `;

    renderCodingTreeUI('coding');
  }


  // ---- Coding Tree sub-tabs renderer ----
  function renderCodingTreeUI(mode){
    const host = document.getElementById('codingTreeHost');
    if (!host || !_currentSystem) return;

    const btnCodingOnly = document.getElementById('ctCodingOnly');
    const btnShowKeys   = document.getElementById('ctShowKeys');

    [btnCodingOnly, btnShowKeys].forEach(b => b && b.classList.remove('active'));
    if (mode === 'coding') {
      if (btnCodingOnly) btnCodingOnly.classList.add('active');
    } else {
      if (btnShowKeys) btnShowKeys.classList.add('active');
    }

    if (btnCodingOnly) btnCodingOnly.onclick = ()=>renderCodingTreeUI('coding');
    if (btnShowKeys)   btnShowKeys.onclick   = ()=>renderCodingTreeUI('keys');

    const lines = _currentSystem.lines ? _currentSystem.lines.slice() : [];

    if (mode === 'coding'){
      host.innerHTML = `<div>${codingLinesToHTML(lines)}</div>`;
      return;
    }

    // --- Show Keys mode ---
    const keyMap = {};
    (_currentSystem.keys || []).forEach(k=>{
      const c = String(k.code||'').trim();
      const s = String(k.stamping||'').trim();
      if (!c || !s) return;
      if (!keyMap[c]) keyMap[c] = [];
      keyMap[c].push(s);
    });

    // build from the SAME base HTML that Coding Only uses
    const htmlRaw = (typeof codingLinesToHTML === 'function')
      ? codingLinesToHTML(lines)
      : lines.join('\n');

      const html = htmlRaw
        .replace(/(?:MAC|DFC|MCV)(?:\s*&(?:amp;)?\s*(?:MAC|DFC|MCV))?\s*Error\b/gi, '')
        .replace(/\s*&\s*(?:MAC|DFC|MCV)\s*Error\b/gi, '')
        .replace(/&amp;/g, '')
        .replace(/((?:GMK|MK\d+|CK\d+\.\d+)\s*-\s*\d+)/g, (m)=>{
          const codeMatch = m.match(/(\d{3,})$/);
          if (!codeMatch) return m;
          const code = codeMatch[1];
          const stamps = keyMap[code] ? `   ${keyMap[code].join(', ')}` : '';
          return m + stamps;
        });





    // render EXACTLY like Coding Only (same wrapper, no <pre>, no trimming)
    host.innerHTML = `<div>${html}</div>`;
  }

  // ---- Coding Check view (Phantoms + Ghosts) ----
    function renderCodingCheckView(){
      if (!_currentSystem) return;
      const content = document.getElementById('systemContent');
      if (!content) return;

      const sortLabel = (_codingCheckSortMode === 'door') ? 'Sort by Number' : 'Sort by Door';

      content.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px;">
          <div class="muted" style="font-size:16px;font-weight:600;">Coding Check</div>
          <div id="codingCheckBox" class="out" style="max-height:60vh;overflow:auto;"></div>
          <div class="btnbar" style="justify-content:flex-end;margin-top:10px;margin-bottom:12px;">
            <button id="codingCheckSort">${sortLabel}</button>
            <button id="codingCheckClear">Clear</button>
            <button id="codingCheckRun" class="primary">Run</button>
          </div>
        </div>
      `;

      const boxEl   = document.getElementById('codingCheckBox');
      const btnRun  = document.getElementById('codingCheckRun');
      const btnClear = document.getElementById('codingCheckClear');
      const btnSort  = document.getElementById('codingCheckSort');

      if (boxEl && _codingCheckLastHtml) {
        boxEl.innerHTML = _codingCheckLastHtml;
      }

       if (btnClear && boxEl) {
         btnClear.onclick = () => {
           boxEl.textContent = '';
           _codingCheckLastHtml = '';
           _codingCheckLastPhantoms = null;
           _codingCheckLastGhosts   = null;
         };
       }
       if (btnRun && boxEl) {
         btnRun.onclick = () => runCodingCheck(boxEl);
       }
       if (btnSort && boxEl) {
         btnSort.onclick = () => {
           _codingCheckSortMode = (_codingCheckSortMode === 'door') ? 'key' : 'door';
           btnSort.textContent = (_codingCheckSortMode === 'door') ? 'Sort by Key & Code' : 'Sort by Door';

           if (_codingCheckLastPhantoms && _codingCheckLastGhosts) {
             rebuildCodingCheckFromCache(boxEl);
           } else {
             runCodingCheck(boxEl);
           }
         };
       }
     }




    
    
    // Timed logger ‚Äì slow typewriter-style prints
    function createSlowLogger(el, delay){
      const queue = [];
      let running = false;
      let onDone = null;

      function process(){
        if (!queue.length){
          running = false;
          if (onDone) onDone();
          return;
        }
        running = true;
        const line = queue.shift();
        el.textContent += (el.textContent ? "\n" : "") + line;
        el.scrollTop = el.scrollHeight;
        setTimeout(process, delay);
      }

      function slowLog(line){
        queue.push(line);
        if (!running) process();
      }

      slowLog.onDone = function(cb){
        onDone = cb;
      };

      return slowLog;
    }

    
    

   let _codingCheckLastPhantoms = null;
   let _codingCheckLastGhosts   = null;

   // ---- Coding Check engine (find phantoms + ghosts) ----
   function runCodingCheck(boxEl){
     if (!boxEl || !_currentSystem) return;


    // start fresh for this run
    boxEl.textContent = '';
    _codingCheckLastHtml = '';

    // slow logger (60ms delay per line ‚Äî adjust as needed)
    const log = createSlowLogger(boxEl, 5);

    const doors = Array.isArray(_currentSystem.doors) ? _currentSystem.doors : [];
    const keys  = Array.isArray(_currentSystem.keys)  ? _currentSystem.keys  : [];

    log('Starting Coding Check...');
    log(`Doors: ${doors.length}, Keys: ${keys.length}`);

    // map numeric code -> [key objs]
    const keyByCode = {};
    keys.forEach(k=>{
      const codeDigits = String(k.code||'').replace(/\D/g,'');
      if (!codeDigits) return;
      if (!keyByCode[codeDigits]) keyByCode[codeDigits] = [];
      keyByCode[codeDigits].push(k);
    });

    // map numeric code -> [labels] from coding tree (GMK/MK/CK)
    const codeLabels = {};
    const treeLines = _currentSystem.lines || [];
    treeLines.forEach(line=>{
      const raw = line.replace(/%c/g,'');
      if (/Error/i.test(raw)) return;  // <-- ignore any line with an Error

      let label = '';
      let code  = '';
      if (/^GMK - /.test(raw)){
        label = 'GMK';
        code  = raw.split(' - ')[1] || '';
      } else if (/^MK\d+/.test(raw)){
        const parts = raw.split(' - ');
        label = parts[0].trim();
        code  = (parts[1]||'').split('  ')[0];
      } else if (/^\s+CK\d+\.\d+/.test(raw)){
        const parts = raw.trim().split(' - ');
        label = parts[0].trim();
        code  = (parts[1]||'').split('  ')[0];
      }
      const digits = String(code||'').replace(/\D/g,'');
      if (!digits || !label) return;
      if (!codeLabels[digits]) codeLabels[digits] = [];
      codeLabels[digits].push(label);
    });


    const phantoms = [];
    const ghosts   = [];

    doors.forEach(door=>{
      const doorStamp = String(door.stamping||'').trim() || '(no stamping)';
      const assignedStamps = new Set(
        Array.isArray(door.keys) ? door.keys.map(s=>String(s||'').trim()) : []
      );

      // keys assigned to THIS door (used to build pin stacks)
      const usedKeys = keys.filter(k=>{
        const st = String(k.stamping||'').trim();
        return st && assignedStamps.has(st);
      });

      const codeLens = usedKeys
        .map(k => String(k.code||'').replace(/\D/g,'').length)
        .filter(n => n > 0);

      if (!codeLens.length){
        log(`Door ${doorStamp}: no assigned key codes, skipping.`);
        return;
      }

      // chamber count = mode of code lengths
      const chamberCount = (()=>{
        const freq = new Map();
        codeLens.forEach(n=>freq.set(n,(freq.get(n)||0)+1));
        return Array.from(freq.entries()).sort((a,b)=>b[1]-a[1] || b[0]-a[0])[0][0];
      })();

      log(`Door ${doorStamp}: chamber count ${chamberCount}`);

      // per-chamber unique sorted cuts (same logic as pinning)
      const perChamberCuts = Array.from({length: chamberCount}, (_, ch)=>{
        const cuts = [];
        usedKeys.forEach(k=>{
          const digits = String(k.code||'').replace(/\D/g,'');
          if (digits.length !== chamberCount) return;
          const d = parseInt(digits[ch],10);
          if (!Number.isNaN(d)) cuts.push(d);
        });
        return Array.from(new Set(cuts)).sort((a,b)=>a-b);
      });

      // all combinations of valid cuts per chamber = all keys that will operate this door
      const combos = [];
      function buildCombo(prefix, idx){
        if (idx >= chamberCount){
          combos.push(prefix.join(''));
          return;
        }
        const options = perChamberCuts[idx];
        if (!options.length){
          return;
        }
        options.forEach(d=>{
          prefix.push(String(d));
          buildCombo(prefix, idx+1);
          prefix.pop();
        });
      }
      buildCombo([],0);

      log(`Door ${doorStamp}: checking ${combos.length} possible codes...`);

      combos.forEach(code=>{
        // PHANTOMS: existing keys with this code but NOT assigned to this door
        const keysForCode = keyByCode[code] || [];
        keysForCode.forEach(k=>{
          const stamp = String(k.stamping||'').trim();
          const assignedHere = stamp && assignedStamps.has(stamp);
          log(`Door ${doorStamp} vs Key ${stamp || '(no stamping)'} [${code}] => ${assignedHere ? 'assigned' : 'PHANTOM'}`);
          if (!assignedHere && stamp){
            phantoms.push({ door: doorStamp, stamp, code });
          }
        });

        // GHOSTS: codes that exist in coding tree but have NO key cut yet
        const hasKeyCut = !!(keyByCode[code] && keyByCode[code].length);
        const labels = codeLabels[code] || [];
        if (!hasKeyCut && labels.length){
          const label = labels[0]; // pick first label for message
          log(`Door ${doorStamp} vs Code ${label} [${code}] => GHOST`);
          ghosts.push({ door: doorStamp, label, code });
        }
      });
    });

     if (_codingCheckSortMode === 'door') {
       // sort phantoms by door, then key stamping
       phantoms.sort((a,b)=>{
         const ad = String(a.door||'').toUpperCase();
         const bd = String(b.door||'').toUpperCase();
         if (ad < bd) return -1;
         if (ad > bd) return 1;
         const as = String(a.stamp||'').toUpperCase();
         const bs = String(b.stamp||'').toUpperCase();
         if (as < bs) return -1;
         if (as > bs) return 1;
         return 0;
       });

       // sort ghosts by door, then code, then label
       ghosts.sort((a,b)=>{
         const ad = String(a.door||'').toUpperCase();
         const bd = String(b.door||'').toUpperCase();
         if (ad < bd) return -1;
         if (ad > bd) return 1;
         const ac = String(a.code||'');
         const bc = String(b.code||'');
         if (ac < bc) return -1;
         if (ac > bc) return 1;
         const al = String(a.label||'').toUpperCase();
         const bl = String(b.label||'').toUpperCase();
         if (al < bl) return -1;
         if (al > bl) return 1;
         return 0;
       });
     } else {
       // sort phantoms by key stamping, then door
       phantoms.sort((a,b)=>{
         const as = String(a.stamp||'').toUpperCase();
         const bs = String(b.stamp||'').toUpperCase();
         if (as < bs) return -1;
         if (as > bs) return 1;
         const ad = String(a.door||'').toUpperCase();
         const bd = String(b.door||'').toUpperCase();
         if (ad < bd) return -1;
         if (ad > bd) return 1;
         return 0;
       });

       // sort ghosts by code, then label
       ghosts.sort((a,b)=>{
         const ac = String(a.code||'');
         const bc = String(b.code||'');
         if (ac < bc) return -1;
         if (ac > bc) return 1;
         const al = String(a.label||'').toUpperCase();
         const bl = String(b.label||'').toUpperCase();
         if (al < bl) return -1;
         if (al > bl) return 1;
         return 0;
       });
     }

     _codingCheckLastPhantoms = phantoms.slice();
     _codingCheckLastGhosts   = ghosts.slice();

     // Build final results output and wipe debug log (per your spec)
     const phantomCount = phantoms.length;
     const ghostCount   = ghosts.length;
     let html = '';

     html += `<div style="margin-bottom:10px;font-size:16px;font-weight:600;">Current Errors (Phantoms = ${phantomCount})</div>`;
     if (!phantoms.length){
       html += `<div class="muted">No phantom keys found.</div>`;
     } else {
       phantoms.forEach(p=>{
         html += `<div class="err">Key <strong>${p.stamp}</strong> will open Door <strong>${p.door}</strong></div>`;
       });
     }

     html += `<div style="margin-top:16px;margin-bottom:10px;font-size:16px;font-weight:600;">Future Errors (Ghosts = ${ghostCount})</div>`;
     if (!ghosts.length){
       html += `<div class="muted">No ghost codes found.</div>`;
     } else {
       ghosts.forEach(g=>{
         html += `<div class="err">Code <strong>${g.label}</strong> will open Door <strong>${g.door}</strong></div>`;
       });
     }


     // after the slow typing finishes, replace the log with the final summary
     log.onDone(()=>{
       _codingCheckLastHtml = html;
       boxEl.textContent = '';
       setTimeout(() => {
         boxEl.innerHTML = html;
         boxEl.scrollTop = 0;
       }, 20);
     });
   }


   function rebuildCodingCheckFromCache(boxEl){
     if (!boxEl || !_codingCheckLastPhantoms || !_codingCheckLastGhosts) return;

     const phantoms = _codingCheckLastPhantoms.slice();
     const ghosts   = _codingCheckLastGhosts.slice();

     if (_codingCheckSortMode === 'door') {
       // sort phantoms by door, then key stamping
       phantoms.sort((a,b)=>{
         const ad = String(a.door||'').toUpperCase();
         const bd = String(b.door||'').toUpperCase();
         if (ad < bd) return -1;
         if (ad > bd) return 1;
         const as = String(a.stamp||'').toUpperCase();
         const bs = String(b.stamp||'').toUpperCase();
         if (as < bs) return -1;
         if (as > bs) return 1;
         return 0;
       });

       // sort ghosts by door, then code, then label
       ghosts.sort((a,b)=>{
         const ad = String(a.door||'').toUpperCase();
         const bd = String(b.door||'').toUpperCase();
         if (ad < bd) return -1;
         if (ad > bd) return 1;
         const ac = String(a.code||'');
         const bc = String(b.code||'');
         if (ac < bc) return -1;
         if (ac > bc) return 1;
         const al = String(a.label||'').toUpperCase();
         const bl = String(b.label||'').toUpperCase();
         if (al < bl) return -1;
         if (al > bl) return 1;
         return 0;
       });
     } else {
       // sort phantoms by key stamping, then door
       phantoms.sort((a,b)=>{
         const as = String(a.stamp||'').toUpperCase();
         const bs = String(b.stamp||'').toUpperCase();
         if (as < bs) return -1;
         if (as > bs) return 1;
         const ad = String(a.door||'').toUpperCase();
         const bd = String(b.door||'').toUpperCase();
         if (ad < bd) return -1;
         if (ad > bd) return 1;
         return 0;
       });

       // sort ghosts by code, then label
       ghosts.sort((a,b)=>{
         const ac = String(a.code||'');
         const bc = String(b.code||'');
         if (ac < bc) return -1;
         if (ac > bc) return 1;
         const al = String(a.label||'').toUpperCase();
         const bl = String(b.label||'').toUpperCase();
         if (al < bl) return -1;
         if (al > bl) return 1;
         return 0;
       });
     }

     const phantomCount = phantoms.length;
     const ghostCount   = ghosts.length;
     let html = '';

     html += `<div style="margin-bottom:10px;font-size:16px;font-weight:600;">Current Errors (Phantoms = ${phantomCount})</div>`;
     if (!phantoms.length){
       html += `<div class="muted">No phantom keys found.</div>`;
     } else {
       phantoms.forEach(p=>{
         html += `<div class="err">Key <strong>${p.stamp}</strong> will open Door <strong>${p.door}</strong></div>`;
       });
     }

     html += `<div style="margin-top:16px;margin-bottom:10px;font-size:16px;font-weight:600;">Future Errors (Ghosts = ${ghostCount})</div>`;
     if (!ghosts.length){
       html += `<div class="muted">No ghost codes found.</div>`;
     } else {
       ghosts.forEach(g=>{
         html += `<div class="err">Code <strong>${g.label}</strong> will open Door <strong>${g.door}</strong></div>`;
       });
     }

     _codingCheckLastHtml = html;
     boxEl.innerHTML = html;
     boxEl.scrollTop = 0;
   }








    
     // ---- Keys view (grid + CRUD) ----
     let _editingKeyIndex = null;
     let _assignSelectedCode = '';

     function persistCurrentSystem(){
       if (!_currentSystem) return;
       const systems = getSystems();
       const i = systems.findIndex(s => s.id === _currentSystem.id);
       if (i >= 0) systems[i] = _currentSystem; else systems.push(_currentSystem);
       setSystems(systems);
     }

     function ensureKeysArray(){
       if (!_currentSystem.keys) _currentSystem.keys = [];
     }

     // ---------- Fast Build (from Coding Tree ‚Üí Keys) ----------
     let _fastBuildConvention = 'numeric'; // 'numeric' => MK1 & 1-1, 'alpha' => MKA & A-1
     let _fastBuildAlloc = 'seq';          // 'seq' => Sequential, 'rand' => Random

     function fastBuildHasErrorCell(err){
       if (!err) return false;
       return /Error/i.test(String(err));
     }

     function fastBuildMkIndexToLetter(idx){
       // 1 -> A, 2 -> B, ... 27 -> AA etc.
       const A = 'A'.charCodeAt(0);
       let n = idx - 1;
       let out = '';
       while (n >= 0){
         out = String.fromCharCode(A + (n % 26)) + out;
         n = Math.floor(n / 26) - 1;
       }
       return out;
     }

     function runFastBuild(convention, allocMode){
       if (!_currentSystem) return;

       // Only allow on empty keys list
       ensureKeysArray();
       if (_currentSystem.keys && _currentSystem.keys.length){
         showMessage('Fast Build can only be used when the Keys list is empty.');
         return;
       }

       const rows = (_currentSystem.rows || []).slice();
       if (!rows.length){
         showMessage('No Coding Tree found for this system. Build and save the system first.');
         return;
       }

       // rows[0] = ["Key","Code","Error"]
       const body = rows.slice(1).filter(r => r && r.length >= 2);

       let gmkRow = null;
       const mkGroups = new Map(); // mkIdx -> { mkLabel, mkCode, mkErr, cks: [] }

       body.forEach(r => {
         const label = String(r[0] || '').trim();
         const code  = String(r[1] || '').trim();
         const err   = (r.length >= 3) ? String(r[2] || '').trim() : '';

         if (!label) return;

         if (label.toUpperCase() === 'GMK'){
           gmkRow = r;
           return;
         }

         let m;
         if ((m = label.match(/^MK(\d+)$/i))){
           const idx = parseInt(m[1], 10);
           if (!mkGroups.has(idx)){
             mkGroups.set(idx, { mkLabel: label.toUpperCase(), mkCode: code, mkErr: fastBuildHasErrorCell(err), cks: [] });
           } else {
             const g = mkGroups.get(idx);
             g.mkLabel = label.toUpperCase();
             g.mkCode  = code;
             g.mkErr   = fastBuildHasErrorCell(err);
           }
           return;
         }

         if ((m = label.match(/^CK(\d+)\.(\d+)$/i))){
           const mkIdx = parseInt(m[1], 10);
           const ckIdx = parseInt(m[2], 10);
           if (!mkGroups.has(mkIdx)){
             mkGroups.set(mkIdx, { mkLabel: 'MK'+mkIdx, mkCode: '', mkErr:false, cks: [] });
           }
           mkGroups.get(mkIdx).cks.push({
             label: label.toUpperCase(),
             code,
             err,
             idx: ckIdx
           });
           return;
         }
       });

       const keys = [];

       // GMK key (if present + not a bad code)
       if (gmkRow && !fastBuildHasErrorCell(gmkRow[2])){
         const gmkCode = String(gmkRow[1] || '').trim();
         if (gmkCode){
           keys.push({
             stamping: 'GMK',
             description: 'Grand Master Key',
             code: gmkCode,
             qty: 0
           });
         }
       }

       // Sort MK groups by numeric index
       const mkIndices = Array.from(mkGroups.keys()).sort((a,b) => a - b);

       mkIndices.forEach(idx => {
         const group = mkGroups.get(idx);
         if (!group) return;

         const goodCks = group.cks.filter(c => c && c.code && !fastBuildHasErrorCell(c.err));
         // We still add MK itself even if there are no good CKs

         let mkStamp;
         let ckBase; // base part for CK stamping (e.g. "1" or "A")

         if (convention === 'alpha'){
           const letter = fastBuildMkIndexToLetter(idx);
           mkStamp = 'MK' + letter;
           ckBase  = letter;
         } else {
           mkStamp = 'MK' + idx;
           ckBase  = String(idx);
         }

        if (group.mkCode && !group.mkErr){
            keys.push({
                stamping: mkStamp,
                description: 'Master Key',
                code: group.mkCode,
                qty: 0
            });
        }


         if (!goodCks.length) return;

         let pool = goodCks.slice();
         if (allocMode === 'rand'){
           // Fisher‚ÄìYates per MK
           for (let i = pool.length - 1; i > 0; i--){
             const j = Math.floor(Math.random() * (i + 1));
             const tmp = pool[i];
             pool[i] = pool[j];
             pool[j] = tmp;
           }
         } else {
           // Sequential: keep CKs ordered by their original index
           pool.sort((a,b) => (a.idx||0) - (b.idx||0));
         }

         pool.forEach((ck, j) => {
           const suffix = j + 1; // 1,2,3,...
           const stamp = ckBase + '-' + suffix;
           keys.push({
             stamping: stamp,
             description: 'Change Key',
             code: ck.code,
             qty: 0
           });
         });
       });

       _currentSystem.keys = keys;
       _keysSelectedIdx = 0;
       persistCurrentSystem();
       renderKeysView();
     }

     function openFastBuildModal(){
       const modal = document.getElementById('fastBuildModal');
       const bd    = document.getElementById('fastBuildBackdrop');
       const btnConvNumeric = document.getElementById('fbConvNumeric');
       const btnConvAlpha   = document.getElementById('fbConvAlpha');
       const btnAllocSeq    = document.getElementById('fbAllocSeq');
       const btnAllocRand   = document.getElementById('fbAllocRand');
       const btnCancel      = document.getElementById('fastBuildCancel');
       const btnGo          = document.getElementById('fastBuildGo');

       if (!modal || !bd || !btnConvNumeric || !btnConvAlpha || !btnAllocSeq || !btnAllocRand || !btnCancel || !btnGo){
         showMessage('Fast Build UI not found.');
         return;
       }

       function syncConv(){
         btnConvNumeric.classList.toggle('selected', _fastBuildConvention === 'numeric');
         btnConvAlpha.classList.toggle('selected', _fastBuildConvention === 'alpha');
       }
       function syncAlloc(){
         btnAllocSeq.classList.toggle('selected', _fastBuildAlloc === 'seq');
         btnAllocRand.classList.toggle('selected', _fastBuildAlloc === 'rand');
       }

       syncConv();
       syncAlloc();

       function close(){
         modal.hidden = true;
         bd.onclick = null;
         btnCancel.onclick = null;
         btnGo.onclick = null;
         btnConvNumeric.onclick = null;
         btnConvAlpha.onclick = null;
         btnAllocSeq.onclick = null;
         btnAllocRand.onclick = null;
       }

       bd.onclick = close;
       btnCancel.onclick = close;

       btnConvNumeric.onclick = () => {
         _fastBuildConvention = 'numeric';
         syncConv();
       };
       btnConvAlpha.onclick = () => {
         _fastBuildConvention = 'alpha';
         syncConv();
       };

       btnAllocSeq.onclick = () => {
         _fastBuildAlloc = 'seq';
         syncAlloc();
       };
       btnAllocRand.onclick = () => {
         _fastBuildAlloc = 'rand';
         syncAlloc();
       };

       btnGo.onclick = () => {
         try {
           runFastBuild(_fastBuildConvention, _fastBuildAlloc);
         } catch (e){
           console.error(e);
           showMessage('Fast Build failed: ' + (e && e.message ? e.message : e));
         }
         close();
       };

       modal.hidden = false;
     }

     function renderKeysView(){
       if (!_currentSystem) return;
      ensureKeysArray();
      const content = document.getElementById('systemContent');
      if (!content) return;

      const rows = _currentSystem.keys;

      let html = '';
       html += '<div class="card" style="padding:0;margin-bottom:16px;">';
       html += '  <div style="max-height:60vh;overflow:auto;">';
       html += '    <div class="keygrid">';
       html += '      <div class="hdr muted">Stamping</div>';
       html += '      <div class="hdr muted">Description</div>';
       html += '      <div class="hdr muted">Code</div>';
       html += '      <div class="hdr muted">Qty</div>';
       html += '    </div>';
       html += '    <div id="keyRows" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"></div>';
       html += '  </div>';
       html += '</div>';

       html += '<div class="card" style="padding:16px;margin-top:16px;">';
       html += '  <div class="btnbar" style="justify-content:flex-end;">';
       html +=        (rows.length === 0 ? '<button id="keyFastBuild" class="primary">Fast Build</button>' : '');
       html += '    <button id="keyAdd">Add</button>';
       html += '    <button id="keyEdit" disabled>Edit</button>';
       html += '    <button id="keyCut" disabled>Cut Keys</button>';
       html += '    <button id="keyDelete" class="warn" disabled>Delete Key</button>';
       html += '  </div>';
       html += '</div>';



      content.innerHTML = html;

       const rowsHost = document.getElementById('keyRows');
       rowsHost.innerHTML = rows.map((k, idx) => {
         return (
           '<button type="button" class="keyrow" data-idx="'+idx+'">' +
             '<div class="keycell">'+(k.stamping||'')+'</div>' +
             '<div class="keycell">'+(k.description||'')+'</div>' +
             '<div class="keycell">'+(k.code||'')+'</div>' +
             '<div class="keycell qty">'+((k.qty||0))+'</div>' +
           '</button>'
         );
       }).join('');

       const btnFast = document.getElementById('keyFastBuild');
       if (btnFast) {
         btnFast.onclick = () => {
           openFastBuildModal();
         };
       }


      let selectedIdx = (_keysSelectedIdx >= 0 && _keysSelectedIdx < rows.length) ? _keysSelectedIdx : -1;
      const rowEls = Array.from(rowsHost.querySelectorAll('.keyrow'));
      const btnEdit = document.getElementById('keyEdit');
      const btnCut  = document.getElementById('keyCut');
      const btnDel  = document.getElementById('keyDelete');

      function selectRow(el){
        rowEls.forEach(r => r.classList.remove('selected'));
        el.classList.add('selected');
        selectedIdx = parseInt(el.getAttribute('data-idx'), 10);
        _keysSelectedIdx = selectedIdx;   // persist selection
        btnEdit.disabled = false;
        btnCut.disabled  = false;
        btnDel.disabled  = false;
      }

      rowEls.forEach(el=>{
        el.onclick = ()=>selectRow(el);
      });

      // re-apply previous selection after render
      if (selectedIdx >= 0 && rowEls[selectedIdx]) {
        const el = rowEls[selectedIdx];
        selectRow(el);
        el.scrollIntoView({ block: "nearest" });
      }



      document.getElementById('keyAdd').onclick = ()=>{
        _editingKeyIndex = null;

        let baseStamp = '';
        if (_keysSelectedIdx >= 0 && _currentSystem && Array.isArray(_currentSystem.keys) && _currentSystem.keys[_keysSelectedIdx]) {
          baseStamp = _currentSystem.keys[_keysSelectedIdx].stamping || '';
        } else if (_currentSystem && Array.isArray(_currentSystem.keys) && _currentSystem.keys.length) {
          baseStamp = _currentSystem.keys[_currentSystem.keys.length - 1].stamping || '';
        }

        const nextStamp = getNextStamping(baseStamp);
        openKeyModal({ stamping: nextStamp, description:'', code:'', qty:0 });
      };


      document.getElementById('keyEdit').onclick = ()=>{
        if (selectedIdx < 0) return;
        _editingKeyIndex = selectedIdx;
        const it = _currentSystem.keys[selectedIdx] || { stamping:'', description:'', code:'', qty:0 };
        openKeyModal(it);
      };

      document.getElementById('keyCut').onclick = ()=>{
        if (selectedIdx < 0) return;

        const m   = document.getElementById('cutKeyModal');
        const qty = document.getElementById('cutQty');
        const go  = document.getElementById('cutConfirm');
        const no  = document.getElementById('cutCancel');
        const bd  = document.getElementById('cutKeyBackdrop');

        const lab = document.getElementById('cutKeyLabel');
        const it  = _currentSystem.keys[selectedIdx];
        lab.textContent = (it && it.stamping) ? it.stamping : '';

        qty.value = '1';
        m.hidden = false;

        function closeCut(){
          m.hidden = true;
          go.onclick = null;
          no.onclick = null;
          bd.onclick = null;
        }


        no.onclick = closeCut;
        bd.onclick = closeCut;

       go.onclick = ()=>{
         const v = Number(qty.value);
         if (!Number.isFinite(v)) { closeCut(); return; }
         ensureKeysArray();
         _currentSystem.keys[selectedIdx].qty =
           (_currentSystem.keys[selectedIdx].qty||0) + Math.floor(v);
         if (_currentSystem.keys[selectedIdx].qty < 0)
           _currentSystem.keys[selectedIdx].qty = 0;
         persistCurrentSystem();
         closeCut();
         renderKeysView();
       };
      };


      document.getElementById('keyDelete').onclick = ()=>{
        if (selectedIdx < 0) return;
        const it = _currentSystem.keys[selectedIdx];
        if (!it) return;

        const m   = document.getElementById('deleteKeyModal');
        const ln  = document.getElementById('deleteKeyLine');
        const go  = document.getElementById('deleteKeyConfirm');
        const no  = document.getElementById('deleteKeyCancel');
        const bd  = document.getElementById('deleteKeyBackdrop');

        ln.textContent = (it.stamping||'') + ' ‚Äì ' + (it.description||'');
        m.hidden = false;

        function closeDel(){
          m.hidden = true;
          go.onclick = null;
          no.onclick = null;
          bd.onclick = null;
        }

        no.onclick = closeDel;
        bd.onclick = closeDel;

        go.onclick = ()=>{
          _currentSystem.keys.splice(selectedIdx,1);
          if (_currentSystem.keys.length > 0) {
            let nextIdx = selectedIdx - 1;
            if (nextIdx < 0) {
              nextIdx = 0;
            }
            if (nextIdx >= _currentSystem.keys.length) {
              nextIdx = _currentSystem.keys.length - 1;
            }
            _keysSelectedIdx = nextIdx;
          } else {
            _keysSelectedIdx = -1;
          }
          persistCurrentSystem();
          closeDel();
          renderKeysView();
        };

      };

    }

    // ---- Doors view (grid + CRUD + Keying) ----
    let _editingDoorIndex = null;
    let _doorsSelectedIdx = -1;  // remember which door is selected across re-renders

    // ---- Keys view selection memory ----
    let _keysSelectedIdx = -1;   // remember which key is selected across re-renders
    let _codingCheckLastHtml = '';  // remember last Coding Check result
    let _codingCheckSortMode = 'key';  // 'key' (by key/code) or 'door'





    function ensureDoorsArray(){
      if (!_currentSystem.doors) _currentSystem.doors = [];
      // door shape: { stamping, description, part, notes, keys: [keyStamping,...] }
    }

    function openDoorModal(model){
      const m = document.getElementById('doorModal');
      document.getElementById('doorStamping').value = model.stamping || '';
      document.getElementById('doorDesc').value     = model.description || '';
      document.getElementById('doorPart').value     = model.part || '';
      document.getElementById('doorNotes').value    = model.notes || '';
      m.hidden = false;
    }
    function closeDoorModal(){ document.getElementById('doorModal').hidden = true; }

    // Door modal buttons
    // Door modal buttons
    document.getElementById('doorBackdrop').onclick = closeDoorModal;
    document.getElementById('doorCancel').onclick   = closeDoorModal;

    function saveDoorFromModal(){
      if (!_currentSystem) return null;
      ensureDoorsArray();
      const obj = {
        stamping   : (document.getElementById('doorStamping').value || '').trim(),
        description: (document.getElementById('doorDesc').value || '').trim(),
        part       : (document.getElementById('doorPart').value || '').trim(),
        notes      : (document.getElementById('doorNotes').value || '').trim(),
        keys       : (_editingDoorIndex!=null && _currentSystem.doors[_editingDoorIndex] && Array.isArray(_currentSystem.doors[_editingDoorIndex].keys))
                      ? _currentSystem.doors[_editingDoorIndex].keys.slice()
                      : []
      };
      let savedIdx = null;
      if (_editingDoorIndex == null){
        // insert after currently selected door; if none, append
        const insertAt = (_doorsSelectedIdx >= 0 && _doorsSelectedIdx < _currentSystem.doors.length)
          ? (_doorsSelectedIdx + 1)
          : _currentSystem.doors.length;
        _currentSystem.doors.splice(insertAt, 0, obj);
        savedIdx = insertAt;
      } else {
        _currentSystem.doors[_editingDoorIndex] = obj;
        savedIdx = _editingDoorIndex;
      }
      _doorsSelectedIdx = savedIdx;
      persistCurrentSystem();
      renderDoorsView();
      return savedIdx;
    }

    document.getElementById('doorSave').onclick     = ()=>{
      const savedIdx = saveDoorFromModal();
      if (savedIdx == null) return;
      closeDoorModal();
    };

    document.getElementById('doorAddAnother').onclick = ()=>{
      const savedIdx = saveDoorFromModal();
      if (savedIdx == null) return;

      const ref = _currentSystem.doors[savedIdx] || {};
      const baseStamp = ref.stamping || '';
      const baseDesc  = ref.description || '';
      const basePart  = ref.part || '';

      const nextStamp = getNextStamping(baseStamp);

      document.getElementById('doorStamping').value = nextStamp;
      document.getElementById('doorDesc').value     = baseDesc;
      document.getElementById('doorPart').value     = basePart;
      document.getElementById('doorNotes').value    = '';
      _editingDoorIndex = null;
    };




    function openDoorKeyingModal(doorIdx){
      const modal = document.getElementById('doorKeyingModal');
      const list  = document.getElementById('doorKeyingList');
      ensureDoorsArray();
      ensureKeysArray();

      // build checkboxes from Keys list
      const allKeys = _currentSystem.keys || [];
      const assigned = new Set((_currentSystem.doors[doorIdx]?.keys) || []);
      let html = '';
      if (!allKeys.length){
        html = '<div class="muted">No keys in system. Add keys first.</div>';
      } else {
        html = '<div style="display:flex;flex-direction:column;gap:6px;">';
        allKeys.forEach((k, i)=>{
          const id = `doorKeying_ck_${i}`;
          const checked = assigned.has(k.stamping||'') ? 'checked' : '';
          html += `
            <label for="${id}" style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="${id}" data-stamp="${(k.stamping||'')}" ${checked}>
              <span><strong>${(k.stamping||'')}</strong> ‚Äì ${(k.description||'')} ${(k.code?('¬∑ '+k.code):'')}</span>
            </label>`;
        });
        html += '</div>';
      }
      list.innerHTML = html;

      function closeKeying(){
        modal.hidden = true;
        document.getElementById('doorKeyingOk').onclick = null;
        document.getElementById('doorKeyingCancel').onclick = null;
        document.getElementById('doorKeyingBackdrop').onclick = null;
        const copyBtn = document.getElementById('doorKeyingCopy');
        if (copyBtn){
          copyBtn.onclick = null;
        }
      }

      const copyBtn = document.getElementById('doorKeyingCopy');

      document.getElementById('doorKeyingCancel').onclick = closeKeying;
      document.getElementById('doorKeyingBackdrop').onclick = closeKeying;

      if (copyBtn){
        copyBtn.onclick = ()=>{
          const checks = Array.from(list.querySelectorAll('input[type=checkbox][data-stamp]'));
          const chosen = checks.filter(c=>c.checked).map(c=>String(c.getAttribute('data-stamp')||'').trim()).filter(Boolean);
          openCopyKeyingModal(doorIdx, chosen);
        };
      }

      document.getElementById('doorKeyingOk').onclick = ()=>{
        const checks = Array.from(list.querySelectorAll('input[type=checkbox][data-stamp]'));
        const chosen = checks.filter(c=>c.checked).map(c=>String(c.getAttribute('data-stamp')||'').trim()).filter(Boolean);
        _currentSystem.doors[doorIdx].keys = chosen;
        persistCurrentSystem();
        closeKeying();
        renderDoorsView();
      };

      modal.hidden = false;
    }


    function openCopyKeyingModal(sourceDoorIdx, baseKeys){
      ensureDoorsArray();

      const modal  = document.getElementById('copyKeyingModal');
      const list   = document.getElementById('copyKeyingList');
      const apply  = document.getElementById('copyKeyingApply');
      const cancel = document.getElementById('copyKeyingCancel');
      const bd     = document.getElementById('copyKeyingBackdrop');

      const doors = (_currentSystem && Array.isArray(_currentSystem.doors)) ? _currentSystem.doors : [];
      let html = '';

      if (!doors.length){
        html = '<div class="muted">No doors in system.</div>';
      } else {
        html = '<div style="display:flex;flex-direction:column;gap:6px;">';
        doors.forEach((d, idx)=>{
          if (idx === sourceDoorIdx) return;
          const stamp = String(d.stamping || '').trim();
          const desc  = String(d.description || '').trim();
          const id    = `copyKeying_ck_${idx}`;
          html += `
            <label for="${id}" style="display:grid;grid-template-columns:auto 1.2fr 2fr;align-items:center;gap:8px;padding:8px 10px;border:1px solid #1e1e1e;border-radius:10px;background:#0e0e0e;cursor:pointer;">
              <input type="checkbox" id="${id}" data-door-idx="${idx}">
              <div><strong>${stamp}</strong></div>
              <div class="muted">${desc}</div>
            </label>`;
        });
        html += '</div>';
      }

      list.innerHTML = html;

      function getChecks(){
        return Array.from(list.querySelectorAll('input[type=checkbox][data-door-idx]'));
      }

      function updateApplyState(){
        const checks   = getChecks();
        const selected = checks.filter(c=>c.checked);
        const count    = selected.length;
        apply.textContent = `Copy keying to ${count} selected`;
        if (count > 0){
          apply.classList.add('primary');
        } else {
          apply.classList.remove('primary');
        }
      }

      updateApplyState();

      getChecks().forEach(c=>{
        c.onchange = updateApplyState;
      });

      function closeCopy(){
        modal.hidden = true;
        cancel.onclick = null;
        bd.onclick = null;
        apply.onclick = null;
        getChecks().forEach(c=>{
          c.onchange = null;
        });
      }

      cancel.onclick = closeCopy;
      bd.onclick = closeCopy;

      apply.onclick = ()=>{
        const checks   = getChecks();
        const selected = checks.filter(c=>c.checked);
        if (!selected.length) return;

        ensureDoorsArray();

        const srcDoor = (_currentSystem.doors && _currentSystem.doors[sourceDoorIdx]) ? _currentSystem.doors[sourceDoorIdx] : null;

        let srcKeys;
        if (Array.isArray(baseKeys)){
          srcKeys = baseKeys.slice();  // use current selection, even if empty
        } else if (srcDoor && Array.isArray(srcDoor.keys)){
          srcKeys = srcDoor.keys.slice();
        } else {
          srcKeys = [];
        }

        if (srcDoor){
          srcDoor.keys = srcKeys.slice();
        }

        selected.forEach(c=>{
          const idxStr = c.getAttribute('data-door-idx');
          const idx    = parseInt(idxStr, 10);
          if (!Number.isNaN(idx) && _currentSystem.doors[idx]){
            _currentSystem.doors[idx].keys = srcKeys.slice();
          }
        });

        persistCurrentSystem();

        const dkModal = document.getElementById('doorKeyingModal');
        if (dkModal){
          dkModal.hidden = true;
        }

        closeCopy();
        renderDoorsView();
      };


      modal.hidden = false;
    }


    // Delete Door modal wiring
    (function(){
      const m  = document.getElementById('deleteDoorModal');
      const ln = document.getElementById('deleteDoorLine');
      const ok = document.getElementById('deleteDoorConfirm');
      const no = document.getElementById('deleteDoorCancel');
      const bd = document.getElementById('deleteDoorBackdrop');


      window._openDeleteDoor = function(idx){
        const it = _currentSystem.doors[idx];
        ln.textContent = `${it?.stamping||''} ‚Äì ${it?.description||''}`;
        m.hidden = false;

        function closeDel(){
          m.hidden = true;
          ok.onclick = null; no.onclick = null; bd.onclick = null;
        }
        no.onclick = closeDel; bd.onclick = closeDel;
        ok.onclick = ()=>{
          _currentSystem.doors.splice(idx,1);
          if (_currentSystem.doors.length > 0) {
            let nextIdx = idx - 1;
            if (nextIdx < 0) {
              nextIdx = 0;
            }
            if (nextIdx >= _currentSystem.doors.length) {
              nextIdx = _currentSystem.doors.length - 1;
            }
            _doorsSelectedIdx = nextIdx;
          } else {
            _doorsSelectedIdx = -1;
          }
          persistCurrentSystem();
          closeDel();
          renderDoorsView();
        };
      };
    })();
    
        // ---- Door Pinning (BP + MP rows, then keys list) ----
    function openDoorPinningModal(doorIdx){
      ensureDoorsArray();
      ensureKeysArray();

      const modal   = document.getElementById('doorPinningModal');
      const chart   = document.getElementById('pinningChart');
      const keysBox = document.getElementById('pinningKeysList');
      const title   = document.getElementById('doorPinningTitle');

      const door = _currentSystem.doors[doorIdx];
      const stamps = Array.isArray(door?.keys) ? door.keys.slice() : [];

      if (title){
        const stamp = String(door?.stamping || '').trim().toUpperCase();
        title.textContent = stamp ? `Pinning for ${stamp}` : 'Pinning';
      }


      // collect key objects for this door based on stamping
      const allKeys = (_currentSystem.keys||[]);
      const usedKeys = stamps
        .map(st => allKeys.find(k => (k.stamping||'').trim() === st))
        .filter(Boolean);

      // render "keys operating this lock" (below chart) ‚Äî single rows
      if (!usedKeys.length){
        keysBox.innerHTML = '<div class="muted">No keys assigned to this door.</div>';
      } else {
        keysBox.innerHTML = usedKeys.map(k=>{
          const s = (k.stamping||'');
          const d = (k.description||'');
          const c = (k.code||'');
          return `<div style="padding:6px 0; border-bottom:1px solid #1e1e1e;">
                    <strong>${s}</strong> ‚Äî ${d||'‚Äî'}${c ? ` ¬∑ ${c}` : ''}
                  </div>`;
        }).join('');
      }


      // Infer chamber count from assigned keys' numeric code lengths (mode of lengths)
      const codeLens = usedKeys
        .map(k => String(k.code||'').replace(/\D/g,'').length)
        .filter(n => n > 0);

      let chamberCount = 0;
      if (codeLens.length){
        const freq = new Map();
        codeLens.forEach(n => freq.set(n, (freq.get(n)||0)+1));
        chamberCount = Array.from(freq.entries()).sort((a,b) => b[1]-a[1] || b[0]-a[0])[0][0];
      }

      if (!chamberCount){
        chart.innerHTML = `<div class="muted">Please add keys to this door first.</div>`;
        wirePinningClose();
        modal.hidden = false;
        return;
      }


      // Build per-chamber unique sorted cuts (using only numeric digits from key codes)
      // Logic mirrors your Python: per chamber sorted unique, BP = min, MPs = consecutive diffs.
      // ref: DanMaster.show_pinning_for_door()  (sorted unique cuts, bp = smallest, MPs = diffs) :contentReference[oaicite:1]{index=1}
      const perChamberCuts = Array.from({length: chamberCount}, (_, ch) => {
        const cuts = [];
        usedKeys.forEach(k=>{
          const codeDigits = String(k.code||'').replace(/\D/g,'');
          if (codeDigits.length === chamberCount){
            const d = parseInt(codeDigits[ch], 10);
            if (!Number.isNaN(d)) cuts.push(d);
          }
        });
        // unique + sort asc
        return Array.from(new Set(cuts)).sort((a,b)=>a-b);
      });

      // Bottom pins row = smallest cut per chamber
      const bpRow = perChamberCuts.map(arr => (arr.length ? arr[0] : ' '));

      // Master pin rows = differences between successive cuts per chamber
      const maxDiffRows = perChamberCuts.reduce((m, arr)=>Math.max(m, Math.max(0, arr.length-1)), 0);
      const mpRows = Array.from({length:maxDiffRows}, _=> Array.from({length:chamberCount}, __=>' '));
      for (let ch=0; ch<chamberCount; ch++){
        const arr = perChamberCuts[ch];
        for (let i=1;i<arr.length;i++){
          const diff = arr[i] - arr[i-1];
          mpRows[i-1][ch] = String(diff);
        }
      }

      // Render chart as a neat grid (headers 1..N)
      const headers = Array.from({length:chamberCount}, (_,i)=>String(i+1));
      let html = '';
      html += `<div class="pinGrid" style="grid-template-columns: 70px repeat(${chamberCount}, minmax(36px,auto));">`;
      html += `<div class="pinCell"><strong>BP</strong></div>${bpRow.map(v=>`<div class="pinCell" style="text-align:center;">${v}</div>`).join('')}`;
      mpRows.forEach((row, idx)=>{
        html += `<div class="pinCell"><strong>MP${idx+1}</strong></div>${row.map(v=>`<div class="pinCell" style="text-align:center;">${v}</div>`).join('')}`;
      });
      html += `</div>`;

      chart.innerHTML = html;

      wirePinningClose();
      modal.hidden = false;

      function wirePinningClose(){
        const close = ()=>{ modal.hidden = true; };
        document.getElementById('doorPinningClose').onclick = close;
        document.getElementById('doorPinningBackdrop').onclick = close;
      }
    }


    function renderDoorsView(){
      if (!_currentSystem) return;
      ensureDoorsArray();
      const content = document.getElementById('systemContent');
      if (!content) return;

      const rows = _currentSystem.doors;

      let html = '';
      html += '<div style="max-height:60vh;overflow:auto;">';
      html += '  <div class="doorgrid">';
      html += '    <div class="hdr muted">Stamping</div>';
      html += '    <div class="hdr muted">Description</div>';
      html += '    <div class="hdr muted">Part Number</div>';
      html += '  </div>';
      html += '  <div id="doorRows" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"></div>';
      html += '</div>';


      html += `
        <div class="btnbar" style="justify-content:flex-end;position:sticky;bottom:0;background:#0e0e0e;padding:12px;border-radius:12px;margin-top:12px;">
          <button id="doorAdd">Add</button>
          <button id="doorEdit" disabled>Edit</button>
          <button id="doorKeying" disabled>Keying</button>
          <button id="doorPinning" disabled>Pinning</button>
          <button id="doorDelete" class="warn" disabled>Delete Door</button>
        </div>
      `;

      content.innerHTML = html;

      const host = document.getElementById('doorRows');
      host.innerHTML = rows.map((d, idx)=>{
        return (
          '<button type="button" class="doorrow" data-idx="'+idx+'">' +
            '<div class="doorcell">'+(d.stamping||'')+'</div>' +
            '<div class="doorcell">'+(d.description||'')+'</div>' +
            '<div class="doorcell">'+(d.part||'')+'</div>' +
          '</button>'
        );
      }).join('');

      let selectedIdx = (_doorsSelectedIdx >= 0 && _doorsSelectedIdx < rows.length) ? _doorsSelectedIdx : -1;
      const rowEls = Array.from(host.querySelectorAll('.doorrow'));
      const btnEdit    = document.getElementById('doorEdit');
      const btnKeying  = document.getElementById('doorKeying');
      const btnPinning = document.getElementById('doorPinning');
      const btnDelete  = document.getElementById('doorDelete');


      function selectRow(el){
        rowEls.forEach(r => r.classList.remove('selected'));
        el.classList.add('selected');
        selectedIdx = parseInt(el.getAttribute('data-idx'), 10);
        _doorsSelectedIdx = selectedIdx;  // persist selection
        btnEdit.disabled    = false;
        btnKeying.disabled  = false;
        btnPinning.disabled = false;
        btnDelete.disabled  = false;
      }

      rowEls.forEach(el=>{ el.onclick = ()=>selectRow(el); });

      // if we had a selection before re-render, re-apply it now
      if (selectedIdx >= 0 && rowEls[selectedIdx]) {
        const el = rowEls[selectedIdx];
        selectRow(el);
        el.scrollIntoView({ block: "nearest" });
      }



      document.getElementById('doorAdd').onclick = ()=>{
        _editingDoorIndex = null;

        let baseStamp = '';
        let baseDesc  = '';
        let basePart  = '';

        if (_doorsSelectedIdx >= 0 && _currentSystem && Array.isArray(_currentSystem.doors) && _currentSystem.doors[_doorsSelectedIdx]) {
          const ref = _currentSystem.doors[_doorsSelectedIdx];
          baseStamp = ref.stamping || '';
          baseDesc  = ref.description || '';
          basePart  = ref.part || '';
        } else if (_currentSystem && Array.isArray(_currentSystem.doors) && _currentSystem.doors.length) {
          const ref = _currentSystem.doors[_currentSystem.doors.length - 1];
          baseStamp = ref.stamping || '';
          baseDesc  = ref.description || '';
          basePart  = ref.part || '';
        }

        const nextStamp = getNextStamping(baseStamp);
        openDoorModal({ stamping: nextStamp, description: baseDesc, part: basePart, notes:'', keys:[] });
      };

      document.getElementById('doorEdit').onclick = ()=>{
        if (selectedIdx < 0) return;
        _editingDoorIndex = selectedIdx;
        const it = _currentSystem.doors[selectedIdx] || { stamping:'', description:'', part:'', notes:'', keys:[] };
        openDoorModal(it);
      };
      document.getElementById('doorKeying').onclick = ()=>{
        if (selectedIdx < 0) return;
        openDoorKeyingModal(selectedIdx);
      };
      document.getElementById('doorPinning').onclick = ()=>{
        if (selectedIdx < 0) return;
        openDoorPinningModal(selectedIdx);
      };
      document.getElementById('doorDelete').onclick = ()=>{
        if (selectedIdx < 0) return;
        window._openDeleteDoor(selectedIdx);
      };

    }

    
          // --- Auto-uppercase for Key Stamping ---
      document.addEventListener('input', e => {
        if (!e.target) return;
        if (e.target.id === 'keyStamping' || e.target.id === 'doorStamping') {
          const cursor = e.target.selectionStart;
          e.target.value = e.target.value.toUpperCase();
          e.target.setSelectionRange(cursor, cursor);
        }
      });

      function getNextStamping(baseStamp){
        if (!baseStamp) return '';
        const s = String(baseStamp).trim();
        if (!s) return '';

        const hyphenIndex = s.lastIndexOf('-');
        let prefix = '';
        let token = s;
        if (hyphenIndex !== -1 && hyphenIndex < s.length - 1) {
          prefix = s.slice(0, hyphenIndex + 1);
          token = s.slice(hyphenIndex + 1);
        }

        const isNumeric = /^\d+$/.test(token);
        const isAlpha   = /^[A-Z]+$/.test(token);

        if (isNumeric) {
          const oldLen = token.length;
          const n = parseInt(token, 10) + 1;
          let nxt = String(n);
          if (oldLen > 1 && nxt.length < oldLen) {
            nxt = nxt.padStart(oldLen, '0');
          }
          return prefix + nxt;
        }

        if (isAlpha) {
          const chars = token.toUpperCase().split('');
          let carry = 1;
          for (let i = chars.length - 1; i >= 0; i--) {
            if (!carry) break;
            const code = chars[i].charCodeAt(0) - 65; // A=0
            const sum = code + carry;
            chars[i] = String.fromCharCode(65 + (sum % 26));
            carry = sum >= 26 ? 1 : 0;
          }
          if (carry) {
            chars.unshift('A');
          }
          return prefix + chars.join('');
        }

        // Mixed prefix + digits (e.g. MK1, D03)
        const prefixDigitsMatch = /^([A-Z]+)(\d+)$/.exec(token.toUpperCase());
        if (prefixDigitsMatch) {
          const basePrefix = prefixDigitsMatch[1];
          const numPart    = prefixDigitsMatch[2];
          const oldLen     = numPart.length;
          const n          = parseInt(numPart, 10) + 1;
          let nxt          = String(n);
          if (oldLen > 1 && nxt.length < oldLen) {
            nxt = nxt.padStart(oldLen, '0');
          }
          return prefix + basePrefix + nxt;
        }

        // Fallback: mixed token, no safe rule ‚Üí return original
        return s;
      }





    // --- Key Editor Modal helpers ---
    function openKeyModal(model){
      const m = document.getElementById('keyModal');
      document.getElementById('keyStamping').value    = model.stamping || '';
      document.getElementById('keyDesc').value        = model.description || '';
      document.getElementById('keyCodeDisplay').value = model.code || '';
      _assignSelectedCode = model.code || '';
      m.hidden = false;
    }
    function closeKeyModal(){
      document.getElementById('keyModal').hidden = true;
    }

    // Key modal buttons
    document.getElementById('keyBackdrop').onclick = closeKeyModal;
    document.getElementById('keyCancel').onclick   = closeKeyModal;

    document.getElementById('keySave').onclick = ()=>{
      if (!_currentSystem) return;
      ensureKeysArray();
      const stamping = (document.getElementById('keyStamping').value || '').trim();
      const desc     = (document.getElementById('keyDesc').value || '').trim();
      const code     = (document.getElementById('keyCodeDisplay').value || '').trim();

      // prevent duplicate stampings within this system
      if (stamping) {
        const upperStamp = stamping.toUpperCase();
        const keysArr = _currentSystem.keys || [];
        const currentIdx = (_editingKeyIndex != null) ? _editingKeyIndex : -1;
        const clash = keysArr.some((k, idx) =>
          idx !== currentIdx &&
          String(k.stamping || '').trim().toUpperCase() === upperStamp
        );
        if (clash) {
          showMessage('Stamping Already Exists.');
          return;
        }
      }

      const obj = { stamping, description: desc, code, qty: (_editingKeyIndex!=null && _currentSystem.keys[_editingKeyIndex]) ? (_currentSystem.keys[_editingKeyIndex].qty||0) : 0 };

      if (_editingKeyIndex == null){
        // insert after currently selected key; if none, append
        const insertAt = (_keysSelectedIdx >= 0 && _keysSelectedIdx < _currentSystem.keys.length)
          ? (_keysSelectedIdx + 1)
          : _currentSystem.keys.length;
        _currentSystem.keys.splice(insertAt, 0, obj);
        _keysSelectedIdx = insertAt;   // keep the new key selected
      } else {
        _currentSystem.keys[_editingKeyIndex] = obj;
        _keysSelectedIdx = _editingKeyIndex;  // keep edited key selected
      }
      persistCurrentSystem();
      closeKeyModal();
      renderKeysView();
    };



    // --- Assign Code Modal ---
    function openAssignModal(){
      const box = document.getElementById('assignTree');
      const lines = (_currentSystem && _currentSystem.lines) ? _currentSystem.lines.slice() : [];

      // Build clickable list (type + error flag)
      const items = [];
      lines.forEach(line=>{
        const raw = line.replace(/%c/g, '');
        let label = '';
        let code  = '';
        let type  = ''; // 'GMK' | 'MK' | 'CK'
        if (/^GMK - /.test(raw)){
          label = 'GMK';
          code  = raw.split(' - ')[1] || '';
          type  = 'GMK';
        } else if (/^MK\d+/.test(raw)){
          const parts = raw.split(' - ');
          label = parts[0].trim();
          code  = (parts[1]||'').split('  ')[0];
          type  = 'MK';
        } else if (/^\s+CK\d+\.\d+/.test(raw)){
          const parts = raw.trim().split(' - ');
          label = parts[0].trim();
          code  = (parts[1]||'').split('  ')[0];
          type  = 'CK';
        }
        if (code){
          const hasErr = /\b(MAC|DFC|MCV)\s*Error\b/i.test(raw);
          items.push({ label, code, type, hasErr, raw });
        }
      });

      // Exclude codes already assigned to other keys (allow current key‚Äôs code while editing)
      const used = new Set(
        ((_currentSystem && _currentSystem.keys) ? _currentSystem.keys : [])
          .map(k => (k.code || '').trim())
          .filter(Boolean)
      );
      if (_editingKeyIndex != null && _currentSystem && _currentSystem.keys[_editingKeyIndex]){
        const currentCode = (_currentSystem.keys[_editingKeyIndex].code || '').trim();
        if (currentCode) used.delete(currentCode);
      }
      const pool = items.filter(it => !used.has(String(it.code).trim()));

      // render helper with colouring + error toggle
      let showErrors = false;
      const toggleBtn = document.getElementById('assignToggleErr');

      function renderList(){
        const list = showErrors ? pool : pool.filter(it => !it.hasErr);
        let html = '<div style="display:flex;flex-direction:column;gap:6px;">';
        if (!list.length){
          html += '<div class="muted">No unassigned codes available.</div>';
        } else {
          list.forEach((it)=>{
            // colour by type (errors override)
            let line = `<strong>${it.label}</strong> ‚Äì ${it.code}`;
            if (it.hasErr) {
                line = `<span class="err">${line}</span>`;
            } else {
                if (it.type === 'GMK')       line = `<span class="tmk">${line}</span>`;
                else if (it.type === 'MK')   line = `<span class="mk">${line}</span>`;
                // CK stays default (white)
            }
            html += `<button type="button" data-code="${it.code}" style="text-align:left;padding:8px 10px;border:1px solid #1e1e1e;border-radius:10px;background:#0a0a0a;cursor:pointer;">${line}</button>`;

          });
        }
        html += '</div>';
        box.innerHTML = html;

        // selection wiring (rebind after each render)
        selectedCode = '';
        const buttons = Array.from(box.querySelectorAll('button[data-code]'));
        buttons.forEach(b=>{
          b.onclick = ()=>{
            buttons.forEach(x=>{
              x.style.borderColor = '#1e1e1e';
              x.style.background  = '#0a0a0a';
            });
            b.style.borderColor = 'var(--accent)';
            b.style.background  = '#0b0b0b';
            selectedCode = String(b.getAttribute('data-code') || '');
          };
        });
      }

      let selectedCode = '';
      renderList();

      if (toggleBtn){
        toggleBtn.textContent = 'Show Errors';
        toggleBtn.onclick = ()=>{
          showErrors = !showErrors;
          toggleBtn.textContent = showErrors ? 'Hide Errors' : 'Show Errors';
          renderList();
        };
      }

      document.getElementById('assignOk').onclick = ()=>{
        if (!selectedCode) { document.getElementById('assignModal').hidden = true; return; }
        _assignSelectedCode = selectedCode;
        document.getElementById('keyCodeDisplay').value = _assignSelectedCode;
        document.getElementById('assignModal').hidden = true;
      };

      document.getElementById('assignCancel').onclick = ()=>{
        document.getElementById('assignModal').hidden = true;
      };

      document.getElementById('assignModal').hidden = false;
    }


     document.getElementById('assignBackdrop').onclick = ()=>{
       document.getElementById('assignModal').hidden = true;
     };

     // Manual Code modal wiring
     document.getElementById('manualCodeBackdrop').onclick = ()=>{
       document.getElementById('manualCodeModal').hidden = true;
     };
     document.getElementById('manualCodeCancel').onclick = ()=>{
       document.getElementById('manualCodeModal').hidden = true;
     };
     document.getElementById('manualCodeOk').onclick = ()=>{
       const input = document.getElementById('manualCodeInput');
       const v = (input.value || '').trim();
       if (!v){
         document.getElementById('manualCodeModal').hidden = true;
         return;
       }
       if (!/^[0-9]+$/.test(v)){
         showMessage('Manual code must contain digits only.');
         return;
       }
       _assignSelectedCode = v;
       document.getElementById('keyCodeDisplay').value = _assignSelectedCode;
       document.getElementById('manualCodeModal').hidden = true;
       document.getElementById('assignModal').hidden = true;
     };


     // Warning modal when key has previously been cut
     document.getElementById('assignWarnBackdrop').onclick = ()=>{
       document.getElementById('assignWarnModal').hidden = true;
     };
     document.getElementById('assignWarnNo').onclick = ()=>{
       document.getElementById('assignWarnModal').hidden = true;
     };
     document.getElementById('assignWarnYes').onclick = ()=>{
       document.getElementById('assignWarnModal').hidden = true;
       openAssignModal();
     };

     // Pencil button opens Manual Code modal
     document.getElementById('assignManual').onclick = ()=>{
       const m = document.getElementById('manualCodeModal');
       const input = document.getElementById('manualCodeInput');
       input.value = '';
       m.hidden = false;
       input.focus();
     };

     // Assign Code button ‚Äì warn if qty > 0 before opening assign list
     document.getElementById('keyAssignOpen').onclick = ()=>{
       if (!_currentSystem) return;
       ensureKeysArray();

       let qty = 0;
       if (_editingKeyIndex != null &&
           _currentSystem.keys &&
           _currentSystem.keys[_editingKeyIndex]) {
         qty = Number(_currentSystem.keys[_editingKeyIndex].qty || 0);
       }

       if (qty > 0){
         document.getElementById('assignWarnModal').hidden = false;
       } else {
         openAssignModal();
       }
     };




    // Build the load list from local storage
    function renderLoadList(){
      _selectedId = null;
      openBtn.disabled = true;

      const systems = getSystems()
        .slice()
        .sort((a, b) => {
          const na = parseInt(String(a.id || '').replace(/\D/g, ''), 10) || 0;
          const nb = parseInt(String(b.id || '').replace(/\D/g, ''), 10) || 0;
          return na - nb;
        });  // numeric sort by system number

      if (!systems.length){
        loadListEl.innerHTML =
          '<div style="padding:16px;color:#aaa">No saved systems found.</div>';
        return;
      }


      loadListEl.innerHTML = '';
      systems.forEach((s, idx)=>{
        const row = document.createElement('button');
        row.type = 'button';
        row.style.cssText =
          'display:flex;justify-content:space-between;align-items:center;width:100%;' +
          'background:#0e0e0e;border:0;border-bottom:1px solid #1e1e1e;color:inherit;' +
          'padding:14px 16px;text-align:left;cursor:pointer';

        const left = document.createElement('div');
        left.innerHTML =
          `<div style="font-weight:600;letter-spacing:0.5px">${(s.id||'')}</div>` +
          `<div style="color:#9aa; font-size:13px; margin-top:2px">${((s.description||'')+'').replace(/</g,'&lt;')}</div>`;

        const right = document.createElement('div');
        right.style.cssText = 'font-size:12px;color:#8a8a8a';
        right.textContent = (s.stats && s.stats.pins) ? `${s.stats.pins}-pin` : '';

        row.appendChild(left);
        row.appendChild(right);

        row.onclick = ()=>{
          // clear previous selection visuals
          [...loadListEl.children].forEach(el=>{
            el.style.borderLeft = '0';
            el.style.background = '#0e0e0e';
          });
          // highlight this one
          row.style.borderLeft = '3px solid var(--accent)';
          row.style.background = '#0b0b0b';
          _selectedId = s.id;
          openBtn.disabled = false;
        };

        // rounding on first/last
        if (idx === 0) row.style.borderTopLeftRadius = row.style.borderTopRightRadius = '12px';
        if (idx === systems.length-1){
          row.style.borderBottom = '0';
          row.style.borderBottomLeftRadius = row.style.borderBottomRightRadius = '12px';
        }

        loadListEl.appendChild(row);
      });
    }
    // System Manager: render list
    function renderManagerList(){
      _managerSelectedId = null;

      const systems = getSystems()
        .slice()
        .sort((a, b) => {
          const na = parseInt(String(a.id || '').replace(/\D/g, ''), 10) || 0;
          const nb = parseInt(String(b.id || '').replace(/\D/g, ''), 10) || 0;
          return na - nb;
        });  // numeric sort by system number

      if (!systems.length){
        managerListEl.innerHTML =
          '<div style="padding:16px;color:#aaa">No saved systems found.</div>';
        return;
      }


      managerListEl.innerHTML = '';
      systems.forEach((s, idx)=>{
        const row = document.createElement('button');
        row.type = 'button';
        row.style.cssText =
          'display:flex;justify-content:space-between;align-items:center;width:100%;' +
          'background:#0e0e0e;border:0;border-bottom:1px solid #1e1e1e;color:inherit;' +
          'padding:14px 16px;text-align:left;cursor:pointer';

        const left = document.createElement('div');
        left.innerHTML =
          `<div style="font-weight:600;letter-spacing:0.5px">${(s.id||'')}</div>` +
          `<div style="color:#9aa; font-size:13px; margin-top:2px">${((s.description||'')+'').replace(/</g,'&lt;')}</div>`;

        const right = document.createElement('div');
        right.style.cssText = 'font-size:12px;color:#8a8a8a';
        right.textContent = (s.stats && s.stats.pins) ? `${s.stats.pins}-pin` : '';

        row.appendChild(left);
        row.appendChild(right);

        row.onclick = ()=>{
          [...managerListEl.children].forEach(el=>{
            el.style.borderLeft = '0';
            el.style.background = '#0e0e0e';
          });
          row.style.borderLeft = '3px solid var(--accent)';
          row.style.background = '#0b0b0b';
          _managerSelectedId = s.id;
        };

        if (idx === 0) row.style.borderTopLeftRadius = row.style.borderTopRightRadius = '12px';
        if (idx === systems.length-1){
          row.style.borderBottom = '0';
          row.style.borderBottomLeftRadius = row.style.borderBottomRightRadius = '12px';
        }

        managerListEl.appendChild(row);
      });

      // ---- Delete button + confirm modal wiring ----
      const confirmDeleteModal    = document.getElementById('confirmDeleteModal');
      const confirmDeleteBackdrop = document.getElementById('confirmDeleteBackdrop');
      const confirmDeleteLine     = document.getElementById('confirmDeleteLine');
      const confirmDeleteGo       = document.getElementById('confirmDeleteGo');
      const confirmDeleteCancel   = document.getElementById('confirmDeleteCancel');
      const btnDelete             = document.getElementById('btnDelete');

      function openConfirmDelete(id, desc){
        confirmDeleteLine.textContent = `${id} - ${desc || ''}`;
        confirmDeleteModal.hidden = false;
      }
      function closeConfirmDelete(){
        confirmDeleteModal.hidden = true;
      }

      confirmDeleteBackdrop.onclick = closeConfirmDelete;
      confirmDeleteCancel.onclick   = ()=>{ closeConfirmDelete(); };

      confirmDeleteGo.onclick = ()=>{
        const systemsNow = getSystems();
        const idx = systemsNow.findIndex(s => s.id === _managerSelectedId);
        if (idx >= 0){
          systemsNow.splice(idx,1);
          setSystems(systemsNow);
        }
        closeConfirmDelete();
        renderManagerList(); // refresh here, stay on manager
      };

      btnDelete.onclick = ()=>{
        if (!_managerSelectedId){
          alert('Select a system to delete.');
          return;
        }
        const sys = getSystems().find(x=>x.id===_managerSelectedId);
        if (!sys){ return; }
        openConfirmDelete(sys.id, sys.description || '');
      };
    }


    
    
    


    // Open selected system into its own System screen
    openBtn.onclick = ()=>{
      if (!_selectedId) return;
      const systems = getSystems();
      const sys = systems.find(x => x.id === _selectedId);
      if (!sys) return;

      _currentSystem = sys; // stash current
      if (sysViewId)   sysViewId.textContent = sys.id || '';
      if (sysViewDesc) sysViewDesc.textContent = sys.description || '';

      // default content view
      const content = document.getElementById('systemContent');
      if (content) content.innerHTML = '<div class="muted">Choose an option above.</div>';

      showSystem();
    };



  </script>
</body>
</html>
